<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eisstockprofi Non-Plus-Ultra</title>
    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #000; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; overflow: hidden; user-select: none; -webkit-user-select: none; }
        
        /* Header & Navigation */
        .header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: #111; border-bottom: 2px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .btn-top { background: #222; border: 1px solid #444; color: white; padding: 12px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 13px; text-transform: uppercase; }
        .btn-top:active { background: #444; }
        
        /* Scoreboard */
        .scoreboard { display: flex; gap: 15px; padding: 20px; height: 200px; }
        .team-card { flex: 1; border: 4px solid; border-radius: 30px; background: linear-gradient(145deg, #0f0f0f, #1a1a1a); display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.8); position: relative; }
        .big-score { font-size: 100px; font-weight: 900; line-height: 1; margin: 5px 0; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        .small-points { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

        /* Stock Buttons */
        .controls { display: flex; gap: 20px; padding: 0 20px 10px; }
        .btn-col { flex: 1; display: flex; flex-direction: column; gap: 12px; }
        .btn-stock { padding: 25px; border: none; border-radius: 18px; color: white; font-weight: 900; font-size: 20px; cursor: pointer; transition: transform 0.1s; box-shadow: 0 6px 0 rgba(0,0,0,0.4); }
        .btn-stock:active { transform: translateY(4px); box-shadow: none; }
        
        /* Navigation Footer */
        .nav-footer { display: flex; justify-content: center; gap: 20px; padding: 20px; }
        .btn-nav { background: #eee; color: #000; border: none; padding: 20px; border-radius: 15px; font-weight: 900; flex: 1; font-size: 14px; cursor: pointer; box-shadow: 0 4px #999; }
        .btn-nav:disabled { opacity: 0.3; cursor: default; }

        /* Overlays (Settings & Win) */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; overflow-y: auto; }
        .tab-bar { display: flex; background: #111; border-bottom: 2px solid #222; }
        .tab { flex: 1; padding: 20px; text-align: center; color: #555; font-weight: bold; cursor: pointer; font-size: 14px; }
        .tab.active { color: var(--color-a); border-bottom: 4px solid var(--color-a); }
        .s-body { padding: 25px; }
        .s-row { margin-bottom: 20px; }
        .s-label { display: block; font-size: 12px; color: #888; margin-bottom: 8px; font-weight: bold; text-transform: uppercase; }
        .s-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 15px; border-radius: 10px; font-size: 18px; box-sizing: border-box; }
        .s-check { display: flex; align-items: center; gap: 15px; margin: 25px 0; background: #111; padding: 20px; border-radius: 15px; border: 1px solid #222; }
        
        /* Win Modal */
        .win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: #0a0a0a; border: 6px solid red; border-radius: 40px; padding: 35px; text-align: center; z-index: 2000; box-shadow: 0 0 50px rgba(255,0,0,0.4); }
        .win-btn-main { background: #28a745; color: white; border: none; padding: 22px; border-radius: 15px; font-weight: 900; font-size: 18px; width: 100%; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-top" onclick="resetGame()">NEU SPIEL</button>
        <div style="text-align:center">
            <h1 style="font-size:16px; margin:0; letter-spacing:1px;">EISSTOCKPROFI</h1>
            <div id="room-info" style="font-size:10px; color:var(--color-a); font-weight:bold;">MODUS: LOKAL</div>
        </div>
        <button class="btn-top" onclick="openSettings()">⚙️ OPTIONEN</button>
    </div>

    <div class="scoreboard">
        <div class="team-card" id="card-a" style="border-color: var(--color-a);">
            <div id="disp-na" class="small-points" style="color:var(--color-a)">TEAM A</div>
            <div id="val-ga" class="big-score">0</div>
            <div id="val-pa" class="small-points">PUNKTE: 0</div>
        </div>
        <div class="team-card" id="card-b" style="border-color: var(--color-b);">
            <div id="disp-nb" class="small-points" style="color:var(--color-b)">TEAM B</div>
            <div id="val-gb" class="big-score">0</div>
            <div id="val-pb" class="small-points">PUNKTE: 0</div>
        </div>
    </div>

    <div class="controls">
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 4)">4 STÖCKE</button>
        </div>
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 4)">4 STÖCKE</button>
        </div>
    </div>

    <div class="nav-footer">
        <button class="btn-nav" id="undo" onclick="historyStep(-1)">← KORREKTUR</button>
        <button class="btn-nav" id="redo" onclick="historyStep(1)">VORWÄRTS →</button>
    </div>

    <div id="win-overlay" class="overlay" style="background: rgba(0,0,0,0.95);">
        <div class="win-modal">
            <h2 id="win-label" style="color:red; margin:0; font-size:30px; font-weight:900;">EINFACHSIEG</h2>
            <div id="win-score-display" style="font-size:70px; font-weight:900; margin:20px 0; color:white;">2 : 1</div>
            <p id="win-result-text" style="font-size:20px; color:#ccc; margin-bottom:5px;"></p>
            <p id="win-payment-text" style="font-size:26px; color:#00ff00; font-weight:bold; margin-bottom:30px;"></p>
            <button class="win-btn-main" onclick="closeWinAndReset()">NEUES SPIEL STARTEN</button>
            <button style="background:none; border:none; color:#666; font-weight:bold; margin-top:20px; cursor:pointer;" onclick="document.getElementById('win-overlay').style.display='none'">Fenster schließen (Korrektur möglich)</button>
        </div>
    </div>

    <div id="settings" class="overlay">
        <div class="tab-bar">
            <div id="t1" class="tab active" onclick="setTab(1)">ALLGEMEIN</div>
            <div id="t2" class="tab" onclick="setTab(2)">ONLINE-MODUS</div>
        </div>
        <div id="s1" class="s-body">
            <div class="s-row"><label class="s-label">Team A Name & Farbe</label>
                <div style="display:flex; gap:10px;"><input id="set-na" class="s-input"><input type="color" id="set-ca" style="width:70px; height:50px; background:none; border:none;"></div>
            </div>
            <div class="s-row"><label class="s-label">Team B Name & Farbe</label>
                <div style="display:flex; gap:10px;"><input id="set-nb" class="s-input"><input type="color" id="set-cb" style="width:70px; height:50px; background:none; border:none;"></div>
            </div>
            <div style="display:flex; gap:15px;">
                <div class="s-row" style="flex:1;"><label class="s-label">1. Stock Pkt</label><input type="number" id="set-p1" class="s-input"></div>
                <div class="s-row" style="flex:1;"><label class="s-label">Folge Stock</label><input type="number" id="set-pn" class="s-input"></div>
            </div>
            <div style="display:flex; gap:15px;">
                <div class="s-row" style="flex:1;"><label class="s-label">Moar bei Pkt</label><input type="number" id="set-pw" class="s-input"></div>
                <div class="s-row" style="flex:1;"><label class="s-label">Einfach (€)</label><input type="number" id="set-pe" class="s-input" step="0.10"></div>
            </div>
            <div class="s-row"><label class="s-label">Dreifach-Sieg Preis (€)</label><input type="number" id="set-pd" class="s-input" step="0.10"></div>
            <div class="s-check">
                <input type="checkbox" id="set-reset" style="transform:scale(2);">
                <label style="font-size:15px; font-weight:bold;">Gegner bei Sieg auf 0 setzen</label>
            </div>
            <button class="win-btn-main" onclick="saveSettings()">KONFIGURATION SPEICHERN</button>
        </div>
        <div id="s2" class="s-body" style="display:none">
            <div id="online-setup">
                <label class="s-label">Dein Spielername</label>
                <input id="user-name" class="s-input" placeholder="Name eingeben..." style="margin-bottom:20px;">
                <button class="btn-nav" style="width:100%; max-width:none; background:#444; color:white;" onclick="hostGame()">RAUM ERÖFFNEN (HOST)</button>
                <div style="text-align:center; margin:25px 0; color:#555; font-weight:bold;">ODER</div>
                <div style="display:flex; gap:10px;">
                    <input id="join-code" class="s-input" placeholder="CODE" style="flex:1; text-transform:uppercase;">
                    <button class="btn-nav" style="flex:1; background:var(--color-a); color:white;" onclick="joinGame()">BEITRETEN</button>
                </div>
            </div>
            <div id="online-active" style="display:none; text-align:center;">
                <p style="color:#666; font-size:12px; margin-bottom:5px;">AKTIVER RAUM-CODE:</p>
                <h1 id="room-code-display" style="font-size:60px; color:#00ff00; margin:0; letter-spacing:5px;">-----</h1>
                <button onclick="shareWhatsApp()" style="background:#25D366; color:white; border:none; padding:15px 30px; border-radius:30px; font-weight:bold; margin-top:30px; font-size:16px;">WhatsApp Einladung</button>
                <p style="margin-top:40px; color:#444; font-size:11px;">Nur der Host kann Einstellungen ändern.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U", authDomain: "eisstock-live.firebaseapp.com", projectId: "eisstock-live", databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // CONFIG & STATE
        let config = JSON.parse(localStorage.getItem('es_ultimate_cfg')) || { na:"Team A", nb:"Team B", ca:"#00BFFF", cb:"#FF4500", p1:6, pn:3, pw:12, pe:0.50, pd:1.50, reset:true };
        let state = { ga:0, pa:0, gb:0, pb:0 };
        
        // HISTORY (10 Steps)
        let history = [JSON.stringify(state)];
        let hIdx = 0;

        // ONLINE VARS
        let room = null;
        let myRole = 'admin';
        let myId = localStorage.getItem('es_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('es_uid', myId);

        const haptic = () => { if(navigator.vibrate) navigator.vibrate(80); };

        window.addStock = (team, count) => {
            if(myRole === 'read') return;
            haptic();
            let n = JSON.parse(history[hIdx]);
            
            if(team === 'A') {
                let p = (n.pa === 0) ? config.p1 + (count-1)*config.pn : count*config.pn;
                n.pa += p;
                if(config.reset) n.pb = 0;
                if(n.pa >= config.pw) { n.ga++; n.pa = 0; n.pb = 0; }
            } else {
                let p = (n.pb === 0) ? config.p1 + (count-1)*config.pn : count*config.pn;
                n.pb += p;
                if(config.reset) n.pa = 0;
                if(n.pb >= config.pw) { n.gb++; n.pa = 0; n.pb = 0; }
            }

            // CHECK GAME END (Total 3 Moare OR 3:0)
            if((n.ga + n.gb >= 3) || n.ga === 3 || n.gb === 3) {
                triggerWin(n);
            }
            pushHistory(n);
        };

        function pushHistory(n) {
            // Remove future states if we were in undo-mode
            history = history.slice(0, hIdx + 1);
            history.push(JSON.stringify(n));
            
            // Limit to last 10 steps (plus current = 11)
            if (history.length > 11) {
                history.shift();
            } else {
                hIdx++;
            }
            state = n;
            syncToCloud();
            render();
        }

        window.historyStep = (dir) => {
            haptic();
            if(dir === -1 && hIdx > 0) hIdx--;
            if(dir === 1 && hIdx < history.length - 1) hIdx++;
            state = JSON.parse(history[hIdx]);
            syncToCloud();
            render();
        };

        function triggerWin(n) {
            const winA = n.ga > n.gb;
            const is30 = (n.ga === 3 || n.gb === 3) && (n.ga === 0 || n.gb === 0);
            const winner = winA ? config.na : config.nb;
            const loser = winA ? config.nb : config.na;
            const preis = is30 ? config.pd : config.pe;

            document.getElementById('win-label').innerText = is30 ? "DREIFACHSIEG" : "EINFACHSIEG";
            document.getElementById('win-score-display').innerText = `${n.ga} : ${n.gb}`;
            document.getElementById('win-result-text').innerText = `${winner} hat die Partie gewonnen!`;
            document.getElementById('win-payment-text').innerText = `${loser} zahlt ${preis.toFixed(2).replace('.',',')} €`;
            document.getElementById('win-overlay').style.display = 'block';
        }

        window.resetGame = () => {
            haptic();
            state = { ga:0, pa:0, gb:0, pb:0 };
            history = [JSON.stringify(state)];
            hIdx = 0;
            syncToCloud();
            render();
        };

        window.closeWinAndReset = () => {
            document.getElementById('win-overlay').style.display = 'none';
            resetGame();
        };

        function render() {
            document.getElementById('val-ga').innerText = state.ga;
            document.getElementById('val-gb').innerText = state.gb;
            document.getElementById('val-pa').innerText = "PUNKTE: " + state.pa;
            document.getElementById('val-pb').innerText = "PUNKTE: " + state.pb;
            document.getElementById('disp-na').innerText = config.na;
            document.getElementById('disp-nb').innerText = config.nb;
            document.documentElement.style.setProperty('--color-a', config.ca);
            document.documentElement.style.setProperty('--color-b', config.cb);
            document.getElementById('disp-na').style.color = config.ca;
            document.getElementById('disp-nb').style.color = config.cb;
            
            // Buttons status
            document.getElementById('undo').disabled = (hIdx <= 0);
            document.getElementById('redo').disabled = (hIdx >= history.length - 1);
        }

        // SETTINGS LOGIC
        window.openSettings = () => {
            document.getElementById('set-na').value = config.na;
            document.getElementById('set-nb').value = config.nb;
            document.getElementById('set-ca').value = config.ca;
            document.getElementById('set-cb').value = config.cb;
            document.getElementById('set-p1').value = config.p1;
            document.getElementById('set-pn').value = config.pn;
            document.getElementById('set-pw').value = config.pw;
            document.getElementById('set-pe').value = config.pe;
            document.getElementById('set-pd').value = config.pd;
            document.getElementById('set-reset').checked = config.reset;
            document.getElementById('settings').style.display = 'block';
        };

        window.saveSettings = () => {
            config.na = document.getElementById('set-na').value || "Team A";
            config.nb = document.getElementById('set-nb').value || "Team B";
            config.ca = document.getElementById('set-ca').value;
            config.cb = document.getElementById('set-cb').value;
            config.p1 = parseInt(document.getElementById('set-p1').value);
            config.pn = parseInt(document.getElementById('set-pn').value);
            config.pw = parseInt(document.getElementById('set-pw').value);
            config.pe = parseFloat(document.getElementById('set-pe').value);
            config.pd = parseFloat(document.getElementById('set-pd').value);
            config.reset = document.getElementById('set-reset').checked;
            
            localStorage.setItem('es_ultimate_cfg', JSON.stringify(config));
            syncToCloud();
            document.getElementById('settings').style.display = 'none';
            render();
        };

        // CLOUD SYNC
        function syncToCloud() {
            if(room && myRole === 'admin') {
                update(ref(db, 'rooms/' + room), { state, settings: config });
            }
        }

        window.hostGame = () => {
            room = Math.random().toString(36).substr(2, 5).toUpperCase();
            myRole = 'admin';
            const name = document.getElementById('user-name').value || "Host";
            set(ref(db, 'rooms/' + room), { 
                state, 
                settings: config, 
                members: { [myId]: { name: name, role: 'admin' } } 
            });
            initLiveSession();
        };

        window.joinGame = () => {
            const c = document.getElementById('join-code').value.toUpperCase();
            const name = document.getElementById('user-name').value || "Gast";
            onValue(ref(db, 'rooms/' + c), (snap) => {
                if(snap.exists()) {
                    room = c;
                    myRole = 'read';
                    update(ref(db, `rooms/${room}/members/${myId}`), { name: name, role: 'read' });
                    initLiveSession();
                } else { alert("Raum nicht gefunden!"); }
            }, { onlyOnce: true });
        };

        function initLiveSession() {
            document.getElementById('online-setup').style.display = 'none';
            document.getElementById('online-active').style.display = 'block';
            document.getElementById('room-code-display').innerText = room;
            document.getElementById('room-info').innerText = "LIVE-RAUM: " + room;
            
            onValue(ref(db, 'rooms/' + room), (snap) => {
                const data = snap.val();
                if(data) {
                    state = data.state;
                    config = data.settings;
                    render();
                }
            });
        }

        window.shareWhatsApp = () => {
            const text = `Komm in meinen Eisstock-Raum! Code: ${room}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        };

        window.setTab = (n) => {
            document.getElementById('s1').style.display = n === 1 ? 'block' : 'none';
            document.getElementById('s2').style.display = n === 2 ? 'block' : 'none';
            document.getElementById('t1').className = n === 1 ? 'tab active' : 'tab';
            document.getElementById('t2').className = n === 2 ? 'tab active' : 'tab';
        };

        render();
    </script>
</body>
</html>
