<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Eisstock Profi</title>
    <meta name="apple-mobile-web-app-title" content="Eisstock Profi">
    <meta name="application-name" content="Eisstock Profi">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"Eisstock Profi","short_name":"Eisstock Profi","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#111111","icons":[{"src":"icon.png","sizes":"192x192","type":"image/png"}]}'>

    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #000; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; overflow: hidden; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        
        .header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #111; border-bottom: 2px solid #333; }
        .btn-top { background: #222; border: 1px solid #444; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        
        .scoreboard { display: flex; gap: 10px; padding: 15px; height: 190px; }
        .team-card { flex: 1; border: 4px solid; border-radius: 25px; background: linear-gradient(145deg, #0f0f0f, #1a1a1a); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; transition: border-color 0.3s; }
        .big-score { font-size: 90px; font-weight: 900; line-height: 1; margin: 5px 0; }
        .small-points { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

        .controls { display: flex; gap: 15px; padding: 0 15px 10px; }
        .btn-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .btn-stock { padding: 22px; border: none; border-radius: 15px; color: white; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 5px 0 rgba(0,0,0,0.5); position: relative; }
        .btn-stock:active { transform: translateY(4px); box-shadow: none; }
        
        .nav-footer { display: flex; justify-content: center; gap: 15px; padding: 15px; }
        .btn-nav { background: #eee; color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: 900; flex: 1; font-size: 14px; cursor: pointer; }
        .btn-nav:disabled { opacity: 0.3; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; overflow-y: auto; }
        .tab-bar { display: flex; background: #111; border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 10; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #555; font-weight: bold; cursor: pointer; }
        .tab.active { color: var(--color-a); border-bottom: 4px solid var(--color-a); }
        .s-body { padding: 20px; padding-bottom: 80px; }
        .s-row { margin-bottom: 15px; }
        .s-label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .s-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .s-input.error { border-color: red; }
        
        .btn-action-row { display: flex; gap: 10px; margin-top: 30px; }
        .btn-save { background: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; flex: 2; cursor: pointer; }
        .btn-cancel { background: #333; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; flex: 1; cursor: pointer; }

        .member-item { display: flex; align-items: center; justify-content: space-between; background: #111; padding: 10px; margin-bottom: 5px; border-radius: 8px; border: 1px solid #222; }
        .mem-name { font-weight: bold; font-size: 14px; }
        .role-sel { background: #222; color: white; border: 1px solid #444; border-radius: 4px; padding: 5px; font-size: 12px; }
        .kick-btn { background: #d9534f; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-weight: bold; cursor: pointer; }

        .win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #0a0a0a; border: 5px solid red; border-radius: 30px; padding: 30px; text-align: center; z-index: 2000; box-shadow: 0 0 100px rgba(255,0,0,0.5); }
        .win-overlay-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1999; }
        
        .role-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 900; background: #333; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-top" onclick="resetGame()">NEU SPIEL</button>
        <div style="text-align:center">
            <h1 style="font-size:15px; margin:0; letter-spacing:1px;">EISSTOCK PROFI</h1>
            <div id="room-info" style="font-size:10px; color:var(--color-a); font-weight:bold;">LOKAL</div>
        </div>
        <button class="btn-top" onclick="openSettings()">‚öôÔ∏è OPTIONEN</button>
    </div>

    <div class="scoreboard">
        <div class="team-card" id="card-a" style="border-color: var(--color-a);">
            <div id="disp-na" class="small-points" style="color:var(--color-a)">TEAM A</div>
            <div id="val-ga" class="big-score">0</div>
            <div id="val-pa" class="small-points">PUNKTE: 0</div>
        </div>
        <div class="team-card" id="card-b" style="border-color: var(--color-b);">
            <div id="disp-nb" class="small-points" style="color:var(--color-b)">TEAM B</div>
            <div id="val-gb" class="big-score">0</div>
            <div id="val-pb" class="small-points">PUNKTE: 0</div>
        </div>
    </div>

    <div class="controls">
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 2)">2 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 3)">3 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 4)">4 ST√ñCKE</button>
        </div>
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 2)">2 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 3)">3 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 4)">4 ST√ñCKE</button>
        </div>
    </div>

    <div class="nav-footer">
        <button class="btn-nav" id="undo" onclick="historyStep(-1)">‚Üê KORREKTUR</button>
        <button class="btn-nav" id="redo" onclick="historyStep(1)">VORW√ÑRTS ‚Üí</button>
    </div>

    <div id="win-overlay-bg" class="win-overlay-bg"></div>
    <div id="win-modal" class="win-modal">
        <h2 id="win-label" style="color:red; margin:0; font-size:28px; font-weight:900;">EINFACHSIEG</h2>
        <div id="win-score-display" style="font-size:60px; font-weight:900; margin:15px 0; color:white;">2 : 1</div>
        <p id="win-result-text" style="font-size:16px; color:#ccc; margin-bottom:5px;"></p>
        <p id="win-payment-text" style="font-size:20px; color:#00ff00; font-weight:bold; margin-bottom:25px;"></p>
        <button class="btn-save" style="width:100%; font-size:18px;" onclick="closeWinAndReset()">NEUES SPIEL STARTEN</button>
    </div>

    <div id="settings" class="overlay">
        <div class="tab-bar">
            <div id="t1" class="tab active" onclick="setTab(1)">ALLGEMEIN</div>
            <div id="t2" class="tab" onclick="setTab(2)">ONLINE-MODUS</div>
        </div>
        
        <div id="s1" class="s-body">
            <div class="s-row"><label class="s-label">Team A Name & Farbe</label>
                <div style="display:flex; gap:10px;"><input id="set-na" class="s-input"><input type="color" id="set-ca" style="width:70px; height:50px; background:none; border:none;"></div>
            </div>
            <div class="s-row"><label class="s-label">Team B Name & Farbe</label>
                <div style="display:flex; gap:10px;"><input id="set-nb" class="s-input"><input type="color" id="set-cb" style="width:70px; height:50px; background:none; border:none;"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="s-row" style="flex:1;"><label class="s-label">1. Stock</label><input type="number" id="set-p1" class="s-input"></div>
                <div class="s-row" style="flex:1;"><label class="s-label">Folge Stock</label><input type="number" id="set-pn" class="s-input"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="s-row" style="flex:1;"><label class="s-label">Einfach (‚Ç¨)</label><input type="number" id="set-pe" class="s-input" step="0.10"></div>
                <div class="s-row" style="flex:1;"><label class="s-label">Dreifach (‚Ç¨)</label><input type="number" id="set-pd" class="s-input" step="0.10"></div>
            </div>
            <div class="btn-action-row">
                <button class="btn-cancel" onclick="closeSettings()">ZUR√úCK</button>
                <button class="btn-save" onclick="saveSettings()">SPEICHERN</button>
            </div>
            <button class="btn-nav" style="width:100%; margin-top:15px; background:#444; color:white;" onclick="resetToDefault()">STANDARD-WERTE LADEN</button>
        </div>
        
        <div id="s2" class="s-body" style="display:none">
            <div id="online-setup">
                <label class="s-label">Dein Spielername</label>
                <input id="user-name" class="s-input" placeholder="Name..." style="margin-bottom:20px;">
                
                <div id="admin-default-box" style="background:#222; padding:15px; border-radius:10px; margin-bottom:20px;">
                     <label class="s-label">Standard f√ºr neue Mitspieler</label>
                     <select id="default-role-sel" class="s-input" onchange="if(room && myRole==='admin') update(ref(db, 'rooms/'+room+'/settings'), {defaultRole: this.value})">
                         <option value="viewer">Zuschauer (Nur gucken)</option>
                         <option value="player">Spieler (Darf z√§hlen)</option>
                     </select>
                </div>

                <button class="btn-nav" style="width:100%; background:var(--color-a); color:white; margin-bottom:20px;" onclick="hostGame()">RAUM ER√ñFFNEN</button>
                <div style="display:flex; gap:10px;">
                    <input id="join-code" class="s-input" placeholder="CODE" style="text-transform:uppercase; flex:1;">
                    <button class="btn-nav" style="flex:1; background:#28a745; color:white;" onclick="joinGame()">BEITRETEN</button>
                </div>
                <button class="btn-cancel" style="width:100%; margin-top:30px;" onclick="closeSettings()">ZUR√úCK ZUM SPIEL</button>
            </div>

            <div id="online-active" style="display:none;">
                <div style="text-align:center; margin-bottom:20px;">
                    <h1 id="room-code-display" style="font-size:50px; color:#00ff00; margin:0;">-----</h1>
                    <div id="role-badge-ui" class="role-badge">ROLLE: ...</div>
                </div>
                
                <button onclick="shareWhatsApp()" style="width:100%; background:#25D366; color:white; border:none; padding:15px; border-radius:30px; font-weight:bold; margin-bottom:20px;">WhatsApp Teilen</button>
                
                <div id="live-admin-settings" style="display:none; background:#111; border:1px solid #333; padding:10px; border-radius:10px; margin-bottom:15px;">
                    <label class="s-label">Neue Spieler werden automatisch:</label>
                    <select id="live-default-role" class="s-input" style="font-size:12px; padding:5px;" onchange="updateDefaultRole(this.value)">
                        <option value="viewer">Zuschauer</option>
                        <option value="player">Spieler</option>
                    </select>
                </div>

                <label class="s-label">MITGLIEDER</label>
                <div id="member-list" style="margin-bottom:20px;"></div>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn-cancel" style="flex:1; background:#d9534f;" onclick="leaveRoom()">VERLASSEN</button>
                    <button class="btn-save" style="flex:1;" onclick="closeSettings()">ZUM SPIEL</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U", authDomain: "eisstock-live.firebaseapp.com", projectId: "eisstock-live", databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const defaultConfig = { na:"Team A", nb:"Team B", ca:"#00BFFF", cb:"#FF4500", p1:6, pn:3, pw:12, pe:0.50, pd:1.50, reset:true, defaultRole:'viewer' };
        let config = JSON.parse(localStorage.getItem('es_final_v1')) || {...defaultConfig};
        let state = { ga:0, pa:0, gb:0, pb:0 };
        let history = [JSON.stringify(state)];
        let hIdx = 0;
        let room = null;
        let myRole = 'admin'; 
        let myId = localStorage.getItem('es_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('es_uid', myId);

        let wakeLock = null;
        async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }

        window.addStock = (team, count) => {
            if(myRole === 'viewer') return;
            if(navigator.vibrate) navigator.vibrate(100);
            let n = JSON.parse(history[hIdx]);
            if(team === 'A') {
                let p = (n.pa === 0) ? config.p1 + (count-1)*config.pn : count*config.pn;
                n.pa += p;
                if(n.pa >= config.pw) { n.ga++; n.pa = 0; if(config.reset) n.pb = 0; }
            } else {
                let p = (n.pb === 0) ? config.p1 + (count-1)*config.pn : count*config.pn;
                n.pb += p;
                if(n.pb >= config.pw) { n.gb++; n.pb = 0; if(config.reset) n.pa = 0; }
            }
            if(n.ga >= 3 || n.gb >= 3) triggerWin(n);
            pushHistory(n);
        };

        function pushHistory(n) {
            history = history.slice(0, hIdx + 1);
            history.push(JSON.stringify(n));
            if(history.length > 15) history.shift(); else hIdx++;
            state = n;
            syncToCloud();
            render();
        }

        window.historyStep = (dir) => {
            if(myRole === 'viewer') return;
            if(dir === -1 && hIdx > 0) hIdx--;
            if(dir === 1 && hIdx < history.length - 1) hIdx++;
            state = JSON.parse(history[hIdx]);
            syncToCloud();
            render();
        };

        window.resetGame = () => {
            if(myRole === 'viewer') return;
            state = { ga:0, pa:0, gb:0, pb:0 };
            history = [JSON.stringify(state)];
            hIdx = 0;
            syncToCloud();
            render();
        };

        function triggerWin(n) {
            const is30 = (n.ga === 3 || n.gb === 3) && (n.ga === 0 || n.gb === 0);
            document.getElementById('win-label').innerText = is30 ? "DREIFACHSIEG" : "EINFACHSIEG";
            document.getElementById('win-score-display').innerText = `${n.ga} : ${n.gb}`;
            document.getElementById('win-payment-text').innerText = `Verlierer zahlt ${(is30 ? config.pd : config.pe).toFixed(2)} ‚Ç¨`;
            document.getElementById('win-overlay-bg').style.display = 'block';
            document.getElementById('win-modal').style.display = 'block';
        }

        window.closeWinAndReset = () => {
            document.getElementById('win-overlay-bg').style.display = 'none';
            document.getElementById('win-modal').style.display = 'none';
            resetGame();
        };

        function render() {
            document.getElementById('val-ga').innerText = state.ga;
            document.getElementById('val-gb').innerText = state.gb;
            document.getElementById('val-pa').innerText = "PUNKTE: " + state.pa;
            document.getElementById('val-pb').innerText = "PUNKTE: " + state.pb;
            document.getElementById('disp-na').innerText = config.na;
            document.getElementById('disp-nb').innerText = config.nb;
            document.documentElement.style.setProperty('--color-a', config.ca);
            document.documentElement.style.setProperty('--color-b', config.cb);
            document.getElementById('undo').disabled = (hIdx <= 0);
            document.getElementById('redo').disabled = (hIdx >= history.length - 1);
            
            const badge = document.getElementById('role-badge-ui');
            if(badge) {
                badge.innerText = "ROLLE: " + myRole.toUpperCase();
                badge.style.color = myRole === 'admin' ? '#00ff00' : (myRole === 'player' ? '#00BFFF' : '#888');
            }
            
            // Admin-spezifische UI Elemente
            const adminSettings = document.getElementById('live-admin-settings');
            if(adminSettings) adminSettings.style.display = (myRole === 'admin') ? 'block' : 'none';
        }

        window.openSettings = () => {
            document.getElementById('set-na').value = config.na;
            document.getElementById('set-nb').value = config.nb;
            document.getElementById('set-ca').value = config.ca;
            document.getElementById('set-cb').value = config.cb;
            document.getElementById('set-pe').value = config.pe;
            document.getElementById('set-pd').value = config.pd;
            document.getElementById('default-role-sel').value = config.defaultRole || 'viewer';
            document.getElementById('settings').style.display = 'block';
        };

        window.saveSettings = () => {
            config.na = document.getElementById('set-na').value;
            config.nb = document.getElementById('set-nb').value;
            config.ca = document.getElementById('set-ca').value;
            config.cb = document.getElementById('set-cb').value;
            config.pe = parseFloat(document.getElementById('set-pe').value);
            config.pd = parseFloat(document.getElementById('set-pd').value);
            config.defaultRole = document.getElementById('default-role-sel').value;
            localStorage.setItem('es_final_v1', JSON.stringify(config));
            syncToCloud();
            closeSettings();
            render();
        };

        window.closeSettings = () => { document.getElementById('settings').style.display = 'none'; };

        window.updateDefaultRole = (val) => {
            if(room && myRole === 'admin') {
                update(ref(db, `rooms/${room}/settings`), { defaultRole: val });
            }
        };

        function syncToCloud() {
            if(room && myRole === 'admin') {
                update(ref(db, 'rooms/' + room), { state, settings: config });
            }
        }

        window.hostGame = () => {
            const name = document.getElementById('user-name').value;
            if(!name) return;
            room = Math.random().toString(36).substr(2, 5).toUpperCase();
            myRole = 'admin';
            const memberRef = ref(db, `rooms/${room}/members/${myId}`);
            onDisconnect(memberRef).remove();
            set(ref(db, 'rooms/' + room), { 
                state, settings: config, members: { [myId]: { name, role: 'admin' } } 
            });
            initLiveSession();
        };

        window.joinGame = () => {
            const name = document.getElementById('user-name').value;
            const c = document.getElementById('join-code').value.toUpperCase();
            if(!name || !c) return;
            onValue(ref(db, 'rooms/' + c), (snap) => {
                if(snap.exists()) {
                    room = c;
                    const data = snap.val();
                    myRole = data.settings?.defaultRole || 'viewer';
                    const mRef = ref(db, `rooms/${room}/members/${myId}`);
                    onDisconnect(mRef).remove();
                    update(mRef, { name, role: myRole });
                    initLiveSession();
                } else alert("Code falsch!");
            }, { onlyOnce: true });
        };

        function initLiveSession() {
            requestWakeLock();
            document.getElementById('online-setup').style.display = 'none';
            document.getElementById('online-active').style.display = 'block';
            document.getElementById('room-code-display').innerText = room;
            document.getElementById('room-info').innerText = "ONLINE: " + room;
            
            onValue(ref(db, 'rooms/' + room), (snap) => {
                const data = snap.val();
                if(!data) return;
                state = data.state;
                if(myRole !== 'admin' && data.settings) {
                    config = data.settings;
                    document.getElementById('live-default-role').value = config.defaultRole;
                }
                if(data.members && data.members[myId]) {
                    myRole = data.members[myId].role;
                    const keys = Object.keys(data.members).sort();
                    if(!Object.values(data.members).some(m => m.role === 'admin') && keys[0] === myId) {
                        myRole = 'admin';
                        update(ref(db, `rooms/${room}/members/${myId}`), { role: 'admin' });
                    }
                } else if(data.members && !data.members[myId]) {
                    leaveRoom();
                }
                render();
                renderMemberList(data.members || {});
            });
        }

        function renderMemberList(members) {
            const list = document.getElementById('member-list');
            list.innerHTML = "";
            Object.keys(members).forEach(uid => {
                const m = members[uid];
                const div = document.createElement('div');
                div.className = 'member-item';
                let ctrls = (myRole === 'admin' && uid !== myId) ? `
                    <div style="display:flex; gap:5px;">
                        <select onchange="updateMemberRole('${uid}', this.value)" class="role-sel">
                            <option value="admin" ${m.role==='admin'?'selected':''}>Admin</option>
                            <option value="player" ${m.role==='player'?'selected':''}>Spieler</option>
                            <option value="viewer" ${m.role==='viewer'?'selected':''}>Zuschauer</option>
                        </select>
                        <button class="kick-btn" onclick="kick('${uid}')">üóëÔ∏è</button>
                    </div>` : `<span style="font-size:10px; color:#666;">${m.role.toUpperCase()}</span>`;
                div.innerHTML = `<span class="mem-name">${m.name} ${uid===myId?'(ICH)':''}</span>${ctrls}`;
                list.appendChild(div);
            });
        }

        window.updateMemberRole = (uid, r) => update(ref(db, `rooms/${room}/members/${uid}`), { role: r });
        window.kick = (uid) => remove(ref(db, `rooms/${room}/members/${uid}`));
        window.setTab = (n) => {
            document.getElementById('s1').style.display = n === 1 ? 'block' : 'none';
            document.getElementById('s2').style.display = n === 2 ? 'block' : 'none';
            document.getElementById('t1').className = n === 1 ? 'tab active' : 'tab';
            document.getElementById('t2').className = n === 2 ? 'tab active' : 'tab';
        };

        window.leaveRoom = () => {
            room = null; myRole = 'admin';
            document.getElementById('online-setup').style.display = 'block';
            document.getElementById('online-active').style.display = 'none';
            document.getElementById('room-info').innerText = "LOKAL";
            render();
        };

        window.shareWhatsApp = () => {
            const url = window.location.href.split('?')[0] + "?join=" + room;
            window.open(`https://wa.me/?text=${encodeURIComponent("Eisstock Profi Spielstand live: " + url)}`);
        };
        
        window.resetToDefault = () => { if(confirm("Alle Einstellungen zur√ºcksetzen?")) { localStorage.clear(); location.reload(); }};

        render();
    </script>
</body>
</html>
