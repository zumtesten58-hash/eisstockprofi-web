<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eisstock Profi Deluxe V3</title>
    <style>
        /* Deine Original-Styles */
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #000; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; overflow: hidden; user-select: none; touch-action: manipulation; background-image: url('hintergrund.jpg'); background-size: cover; background-position: center; }
        .header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: rgba(17,17,17,0.8); border-bottom: 2px solid #333; }
        .btn-top { background: #222; border: 1px solid #444; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .scoreboard { display: flex; gap: 10px; padding: 15px; height: 190px; }
        .team-card { flex: 1; border: 4px solid; border-radius: 25px; background: linear-gradient(145deg, rgba(15,15,15,0.9), rgba(26,26,26,0.9)); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .big-score { font-size: 90px; font-weight: 900; line-height: 1; margin: 5px 0; }
        .small-points { font-size: 14px; font-weight: 800; text-transform: uppercase; }
        .controls { display: flex; gap: 15px; padding: 0 15px 10px; }
        .btn-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .btn-stock { padding: 22px; border: none; border-radius: 15px; color: white; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 5px 0 rgba(0,0,0,0.5); }
        .btn-stock:active { transform: translateY(4px); box-shadow: none; }
        .nav-footer { display: flex; justify-content: center; gap: 15px; padding: 15px; }
        .btn-nav { background: #eee; color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: 900; flex: 1; font-size: 14px; cursor: pointer; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; overflow-y: auto; }
        .tab-bar { display: flex; background: #111; border-bottom: 2px solid #333; position: sticky; top: 0; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #555; font-weight: bold; cursor: pointer; }
        .tab.active { color: var(--color-a); border-bottom: 4px solid var(--color-a); }
        .s-body { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .s-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border 0.3s; }
        .error-blink { border: 2px solid red !important; }
        .btn-save { background: #28a745; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #0a0a0a; border: 5px solid red; border-radius: 30px; padding: 30px; text-align: center; z-index: 2000; }
    </style>
</head>
<body>

<div class="header">
    <button class="btn-top" onclick="resetGame()">NEU SPIEL</button>
    <div style="text-align:center">
        <h1 style="font-size:15px; margin:0;">EISSTOCK PROFI</h1>
        <div id="room-info" style="font-size:10px; color:var(--color-a); font-weight:bold;">LOKAL</div>
    </div>
    <button class="btn-top" onclick="openSettings()">⚙️ OPTIONEN</button>
</div>

<div class="scoreboard">
    <div class="team-card" id="card-a"><div id="disp-na" class="small-points">TEAM A</div><div id="val-ga" class="big-score">0</div><div id="val-pa" class="small-points">PUNKTE: 0</div></div>
    <div class="team-card" id="card-b"><div id="disp-nb" class="small-points">TEAM B</div><div id="val-gb" class="big-score">0</div><div id="val-pb" class="small-points">PUNKTE: 0</div></div>
</div>

<div class="controls">
    <div class="btn-col">
        <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 1)">1 STOCK</button>
        <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 2)">2 STÖCKE</button>
        <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 3)">3 STÖCKE</button>
        <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 4)">4 STÖCKE</button>
    </div>
    <div class="btn-col">
        <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 1)">1 STOCK</button>
        <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 2)">2 STÖCKE</button>
        <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 3)">3 STÖCKE</button>
        <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 4)">4 STÖCKE</button>
    </div>
</div>

<div class="nav-footer">
    <button class="btn-nav" onclick="historyStep(-1)">← KORREKTUR</button>
    <button class="btn-nav" onclick="historyStep(1)">VORWÄRTS →</button>
</div>

<div id="win-modal" class="win-modal">
    <h2 id="win-label">SIEG!</h2>
    <div id="win-score-display" style="font-size:60px; font-weight:900;">0 : 0</div>
    <p id="win-payment-text"></p>
    <button class="btn-save" onclick="resetGame()">NEUES SPIEL</button>
</div>

<div id="settings" class="overlay">
    <div class="tab-bar">
        <div id="t1" class="tab active" onclick="setTab(1)">ALLGEMEIN</div>
        <div id="t2" class="tab" onclick="setTab(2)">ONLINE</div>
    </div>
    <div id="s1" class="s-body">
        <input id="set-na" class="s-input" placeholder="Team A Name">
        <input id="set-nb" class="s-input" placeholder="Team B Name">
        <button class="btn-save" onclick="saveSettings()">Speichern</button>
        <button class="btn-top" onclick="closeSettings()">Abbrechen</button>
    </div>
    <div id="s2" class="s-body" style="display:none">
        <input id="user-name" class="s-input" placeholder="DEIN NAME">
        <button class="btn-save" onclick="hostGame()">RAUM ERSTELLEN</button>
        <hr>
        <input id="join-code" class="s-input" placeholder="RAUM-CODE">
        <button class="btn-top" onclick="joinGame()">BEITRETEN</button>
        <div id="online-active" style="display:none; margin-top:20px;">
            <p>CODE: <b id="room-code-display"></b></p>
            <button class="btn-save" style="background:#25D366" onclick="shareWhatsApp()">WhatsApp Einladung</button>
            <button class="btn-top" onclick="leaveRoom()">Raum verlassen</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U",
        authDomain: "eisstock-live.firebaseapp.com",
        databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "eisstock-live",
        storageBucket: "eisstock-live.firebasestorage.app",
        messagingSenderId: "201538137304",
        appId: "1:201538137304:web:78362c30c45c006cb63bad",
        measurementId: "G-0G8RJF9LK2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const analytics = getAnalytics(app);

    const DEFAULTS = { na:"Team A", nb:"Team B", ca:"#00BFFF", cb:"#FF4500", p1:6, pn:3, pw:12, pe:0.50, pe3:1.50, r0: true };
    let config = JSON.parse(localStorage.getItem('es_v3_cfg')) || {...DEFAULTS};
    let state = { ga:0, pa:0, gb:0, pb:0, win: false, history: [], hIdx: -1 };
    let room = localStorage.getItem('es_room');
    let myId = localStorage.getItem('es_uid') || Math.random().toString(36).substr(2, 9);
    localStorage.setItem('es_uid', myId);

    window.addStock = (team, count) => {
        if(state.win) return;
        let n = JSON.parse(JSON.stringify(state));
        let val = (team === 'A') ? n.pa : n.pb;
        let p = (val === 0) ? parseInt(config.p1) + (count-1)*parseInt(config.pn) : count*parseInt(config.pn);
        
        if(team === 'A') {
            n.pa += p;
            if(n.pa >= config.pw) { n.ga++; n.pa = 0; if(config.r0) n.pb = 0; }
        } else {
            n.pb += p;
            if(n.pb >= config.pw) { n.gb++; n.pb = 0; if(config.r0) n.pa = 0; }
        }

        // LOGIK: Wenn A + B = 3, dann AUS
        if((n.ga + n.gb) === 3) {
            n.win = true;
            logEvent(analytics, 'game_finished', { score: `${n.ga}:${n.gb}` });
        }

        broadcast(updateHistory(n));
    };

    function broadcast(n) {
        if(room) {
            update(ref(db, 'rooms/' + room + '/state'), n);
            update(ref(db, 'rooms/' + room), { lastUpdate: Date.now() });
        } else {
            state = n;
            render();
        }
    }

    window.hostGame = () => {
        const nameInput = document.getElementById('user-name');
        if(!nameInput.value.trim()) {
            nameInput.classList.add('error-blink');
            setTimeout(() => nameInput.classList.remove('error-blink'), 1000);
            return;
        }
        const newRoom = Math.random().toString(36).substr(2, 5).toUpperCase();
        const initial = { state: state, settings: config, createdAt: Date.now(), members: {[myId]: nameInput.value} };
        set(ref(db, 'rooms/' + newRoom), initial);
        room = newRoom;
        localStorage.setItem('es_room', room);
        localStorage.setItem('es_name', nameInput.value);
        initSession();
    };

    window.joinGame = (forcedCode) => {
        const code = forcedCode || document.getElementById('join-code').value.toUpperCase();
        let name = localStorage.getItem('es_name');
        if(!name) {
            name = prompt("Bitte gib deinen Namen ein:");
            if(!name) return;
            localStorage.setItem('es_name', name);
        }
        update(ref(db, `rooms/${code}/members/${myId}`), name).then(() => {
            room = code;
            localStorage.setItem('es_room', room);
            initSession();
        }).catch(() => alert("Raum existiert nicht!"));
    };

    function initSession() {
        onValue(ref(db, 'rooms/' + room), (snap) => {
            const data = snap.val();
            if(data) {
                state = data.state;
                config = data.settings;
                render();
                document.getElementById('online-active').style.display = 'block';
                document.getElementById('room-code-display').innerText = room;
            }
        });
    }

    window.shareWhatsApp = () => {
        const webUrl = "https://deine-github-seite.github.io/"; // HIER DEINE URL EINTRAGEN
        const link = webUrl + "?join=" + room;
        window.open(`https://wa.me/?text=Komm in den Eisstock-Raum: ${link}`);
    };

    // Auto-Join Logik bei App-Start / Seiten-Aufruf
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('join')) {
        joinGame(urlParams.get('join'));
    } else if(room) {
        initSession();
    }

    // Standardfunktionen (render, settings etc.) bleiben wie in deinem Original
    function render() {
        document.getElementById('val-ga').innerText = state.ga;
        document.getElementById('val-gb').innerText = state.gb;
        document.getElementById('val-pa').innerText = "PUNKTE: " + state.pa;
        document.getElementById('val-pb').innerText = "PUNKTE: " + state.pb;
        if(state.win) {
            document.getElementById('win-modal').style.display = 'block';
            document.getElementById('win-score-display').innerText = `${state.ga} : ${state.gb}`;
        } else {
            document.getElementById('win-modal').style.display = 'none';
        }
    }
    window.resetGame = () => { state = { ga:0, pa:0, gb:0, pb:0, win: false, history: [], hIdx: -1 }; broadcast(state); };
    window.setTab = (n) => { document.getElementById('s1').style.display = n === 1 ? 'block' : 'none'; document.getElementById('s2').style.display = n === 2 ? 'block' : 'none'; };
    window.openSettings = () => document.getElementById('settings').style.display = 'block';
    window.closeSettings = () => document.getElementById('settings').style.display = 'none';
    function updateHistory(n) { /* Deine History-Logik */ return n; }
    render();
</script>
</body>
</html>
