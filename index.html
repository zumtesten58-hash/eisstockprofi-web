<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eisstockprofi Pro Ultimate</title>
    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #000; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; user-select: none; }
        
        /* Header */
        .header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #111; border-bottom: 2px solid #222; }
        .btn-top { background: #333; border: 1px solid #555; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .header-title { text-align: center; flex: 1; }
        .header-title h1 { font-size: 16px; margin: 0; letter-spacing: 1px; }

        /* Scoreboard */
        .scoreboard { display: flex; gap: 10px; padding: 15px; height: 180px; }
        .team-card { flex: 1; border: 4px solid; border-radius: 25px; background: #0a0a0a; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s; }
        .big-score { font-size: 90px; font-weight: 900; line-height: 1; margin: 5px 0; }
        .small-points { font-size: 14px; font-weight: bold; text-transform: uppercase; }

        /* Stock Buttons */
        .controls { display: flex; gap: 15px; padding: 0 15px 10px; }
        .btn-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .btn-stock { padding: 22px; border: none; border-radius: 15px; color: white; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 4px #000; }
        .btn-stock:active { transform: translateY(2px); box-shadow: none; }
        
        /* Navigation */
        .nav-footer { display: flex; justify-content: center; gap: 20px; padding: 15px; }
        .btn-nav { background: white; color: black; border: none; padding: 18px; border-radius: 10px; font-weight: 900; flex: 1; max-width: 160px; font-size: 14px; cursor: pointer; }

        /* Settings Overlay */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; overflow-y: auto; }
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #666; font-weight: bold; border-bottom: 3px solid transparent; cursor: pointer; }
        .tab.active { color: var(--color-a); border-bottom-color: var(--color-a); }
        .s-body { padding: 20px; }
        .s-row { margin-bottom: 15px; }
        .s-label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; }
        .s-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .s-check { display: flex; align-items: center; gap: 12px; margin: 20px 0; background: #111; padding: 15px; border-radius: 10px; }
        
        /* Sieg-Modal */
        .win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: #111; border: 5px solid red; border-radius: 30px; padding: 30px; text-align: center; z-index: 2000; box-sizing: border-box; }
        .win-title { font-size: 32px; font-weight: 900; color: red; margin: 0; }
        .win-score-display { font-size: 60px; font-weight: 900; margin: 15px 0; color: white; }
        .win-detail { font-size: 18px; color: #fff; margin-bottom: 10px; }
        .win-money { font-size: 24px; color: #00ff00; font-weight: bold; margin-bottom: 25px; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-top" onclick="resetGame()">Neues Spiel</button>
        <div class="header-title">
            <h1>EISSTOCKPROFI PRO</h1>
            <div id="room-info" style="font-size:10px; color:var(--color-a); font-weight:bold;">LOKALER MODUS</div>
        </div>
        <button class="btn-top" onclick="openSettings()">⚙️ EINSTELLUNGEN</button>
    </div>

    <div class="scoreboard">
        <div class="team-card" id="card-a" style="border-color: var(--color-a);">
            <div id="disp-na" class="small-points" style="color: var(--color-a);">TEAM A</div>
            <div id="val-ga" class="big-score">0</div>
            <div id="val-pa" class="small-points">TEIL: 0</div>
        </div>
        <div class="team-card" id="card-b" style="border-color: var(--color-b);">
            <div id="disp-nb" class="small-points" style="color: var(--color-b);">TEAM B</div>
            <div id="val-gb" class="big-score">0</div>
            <div id="val-pb" class="small-points">TEIL: 0</div>
        </div>
    </div>

    <div class="controls">
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 4)">4 STÖCKE</button>
        </div>
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 4)">4 STÖCKE</button>
        </div>
    </div>

    <div class="nav-footer">
        <button class="btn-nav" id="undo" onclick="step(-1)">KORREKTUR</button>
        <button class="btn-nav" id="redo" onclick="step(1)">VORWÄRTS</button>
    </div>

    <div id="win-overlay" class="overlay" style="background: rgba(0,0,0,0.9);">
        <div class="win-modal">
            <div id="win-type-label" class="win-title">EINFACHSIEG</div>
            <div id="win-score-box" class="win-score-display">2 : 1</div>
            <div id="win-text-detail" class="win-detail">Hansi gewinnt!</div>
            <div id="win-money-detail" class="win-money">Seppl zahlt 0,50 €</div>
            <button class="btn-nav" style="max-width:none; width:100%; background:#28a745; color:white;" onclick="closeWin()">NÄCHSTE PARTIE</button>
        </div>
    </div>

    <div id="settings" class="overlay">
        <div class="tab-bar">
            <div id="t1" class="tab active" onclick="setTab(1)">ALLGEMEIN</div>
            <div id="t2" class="tab" onclick="setTab(2)">ONLINE-MODUS</div>
        </div>
        <div id="s1" class="s-body">
            <div class="s-row">
                <label class="s-label">NAME & FARBE TEAM A</label>
                <div style="display:flex; gap:10px;">
                    <input id="in-na" class="s-input" placeholder="Name A">
                    <input type="color" id="in-ca" style="width:60px; height:45px; border:none; background:none;">
                </div>
            </div>
            <div class="s-row">
                <label class="s-label">NAME & FARBE TEAM B</label>
                <div style="display:flex; gap:10px;">
                    <input id="in-nb" class="s-input" placeholder="Name B">
                    <input type="color" id="in-cb" style="width:60px; height:45px; border:none; background:none;">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="s-row" style="flex:1;">
                    <label class="s-label">PREIS EINFACH (€)</label>
                    <input type="number" id="in-pe" class="s-input" step="0.10">
                </div>
                <div class="s-row" style="flex:1;">
                    <label class="s-label">PREIS DREIFACH (€)</label>
                    <input type="number" id="in-pd" class="s-input" step="0.10">
                </div>
            </div>
            <div class="s-check">
                <input type="checkbox" id="in-reset" style="transform:scale(1.8);">
                <label style="font-size:14px; font-weight:bold;">Gegner auf Null setzen bei Treffer</label>
            </div>
            <button class="btn-nav" style="background:#28a745; color:white; width:100%; max-width:none;" onclick="saveConfig()">SPEICHERN & ZURÜCK</button>
            <button class="btn-nav" style="background:#333; color:white; width:100%; max-width:none; margin-top:10px;" onclick="closeSettings()">ABBRECHEN</button>
        </div>
        <div id="s2" class="s-body" style="display:none">
            <p style="font-size:12px; color:#888;">Online-Modus ist aktiv. Teile deinen Code, um gemeinsam zu zählen.</p>
            <input id="host-name" class="s-input" placeholder="Dein Name">
            <button class="btn-nav" style="width:100%; max-width:none; background:#444; color:white; margin:10px 0;" onclick="host()">GRUPPE HOSTEN</button>
            <div id="active-view" style="display:none; text-align:center; margin-top:20px;">
                <p style="color:#666; font-size:10px;">CODE:</p>
                <h1 id="disp-code" style="font-size:40px; color:#00ff00; margin:0;">-----</h1>
                <button onclick="shareWA()" style="background:#25D366; color:white; border:none; padding:12px; border-radius:20px; font-weight:bold; margin-top:15px;">WhatsApp Einladung</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U", authDomain: "eisstock-live.firebaseapp.com", projectId: "eisstock-live", databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Standard-Einstellungen
        let config = JSON.parse(localStorage.getItem('es_v5_cfg')) || { 
            na:"Hansi", nb:"Seppl", ca:"#00BFFF", cb:"#FF4500", reset:true, pe:0.50, pd:1.50 
        };
        let state = { ga:0, pa:0, gb:0, pb:0 };
        let history = [JSON.stringify(state)];
        let hIdx = 0;
        let room = null;
        let myRole = 'admin';

        const vib = () => { if(navigator.vibrate) navigator.vibrate(60); };

        window.addStock = (team, count) => {
            if(myRole === 'read') return;
            vib();
            let n = JSON.parse(history[hIdx]);
            
            if(team === 'A') {
                let pts = (n.pa === 0) ? 6 + (count-1)*3 : count*3;
                n.pa += pts;
                if(config.reset) n.pb = 0;
                if(n.pa >= 12) { n.ga++; n.pa = 0; n.pb = 0; }
            } else {
                let pts = (n.pb === 0) ? 6 + (count-1)*3 : count*3;
                n.pb += pts;
                if(config.reset) n.pa = 0;
                if(n.pb >= 12) { n.gb++; n.pa = 0; n.pb = 0; }
            }

            // Deine Sieg-Regel: Partie aus bei 3:0/0:3 ODER wenn Summe = 3 (2:1/1:2)
            let total = n.ga + n.gb;
            if(n.ga === 3 || n.gb === 3 || total === 3) {
                showWin(n);
            }
            saveState(n);
        };

        function showWin(n) {
            const winA = n.ga > n.gb;
            const winnerName = winA ? config.na : config.nb;
            const loserName = winA ? config.nb : config.na;
            const isDreifach = (n.ga === 3 || n.gb === 3); // Bei insgesamt 3 Punkten ist 3:0/0:3 automatisch Dreifach
            
            const typ = isDreifach ? "DREIFACHSIEG" : "EINFACHSIEG";
            const preis = isDreifach ? config.pd : config.pe;

            document.getElementById('win-type-label').innerText = typ;
            document.getElementById('win-score-box').innerText = `${n.ga} : ${n.gb}`;
            document.getElementById('win-text-detail').innerText = `${winnerName} gewinnt!`;
            document.getElementById('win-money-detail').innerText = `${loserName} zahlt ${preis.toFixed(2).replace('.',',')} €`;
            
            document.getElementById('win-overlay').style.display = 'block';
        }

        window.saveState = (n) => {
            if(n) {
                history = history.slice(0, hIdx + 1);
                history.push(JSON.stringify(n));
                hIdx++;
                state = n;
            }
            if(room && myRole === 'admin') update(ref(db, 'rooms/' + room), { state, settings: config });
            render();
        };

        window.step = (dir) => {
            if(dir === -1 && hIdx > 0) hIdx--;
            if(dir === 1 && hIdx < history.length - 1) hIdx++;
            state = JSON.parse(history[hIdx]);
            saveState();
        };

        window.resetGame = () => { vib(); state = { ga:0, pa:0, gb:0, pb:0 }; saveState(state); };
        window.closeWin = () => { document.getElementById('win-overlay').style.display = 'none'; resetGame(); };

        function render() {
            document.getElementById('val-ga').innerText = state.ga;
            document.getElementById('val-gb').innerText = state.gb;
            document.getElementById('val-pa').innerText = "TEIL: " + state.pa;
            document.getElementById('val-pb').innerText = "TEIL: " + state.pb;
            document.getElementById('disp-na').innerText = config.na;
            document.getElementById('disp-nb').innerText = config.nb;
            document.documentElement.style.setProperty('--color-a', config.ca);
            document.documentElement.style.setProperty('--color-b', config.cb);
            document.getElementById('disp-na').style.color = config.ca;
            document.getElementById('disp-nb').style.color = config.cb;
            document.getElementById('undo').disabled = hIdx <= 0;
            document.getElementById('redo').disabled = hIdx >= history.length - 1;
        }

        window.saveConfig = () => {
            config.na = document.getElementById('in-na').value || "Team A";
            config.nb = document.getElementById('in-nb').value || "Team B";
            config.ca = document.getElementById('in-ca').value;
            config.cb = document.getElementById('in-cb').value;
            config.pe = parseFloat(document.getElementById('in-pe').value) || 0;
            config.pd = parseFloat(document.getElementById('in-pd').value) || 0;
            config.reset = document.getElementById('in-reset').checked;
            localStorage.setItem('es_v5_cfg', JSON.stringify(config));
            saveState();
            closeSettings();
        };

        window.openSettings = () => {
            document.getElementById('in-na').value = config.na;
            document.getElementById('in-nb').value = config.nb;
            document.getElementById('in-ca').value = config.ca;
            document.getElementById('in-cb').value = config.cb;
            document.getElementById('in-pe').value = config.pe;
            document.getElementById('in-pd').value = config.pd;
            document.getElementById('in-reset').checked = config.reset;
            document.getElementById('settings').style.display = 'block';
        };
        window.closeSettings = () => document.getElementById('settings').style.display = 'none';
        window.setTab = (n) => {
            document.getElementById('s1').style.display = n === 1 ? 'block' : 'none';
            document.getElementById('s2').style.display = n === 2 ? 'block' : 'none';
            document.getElementById('t1').className = n === 1 ? 'tab active' : 'tab';
            document.getElementById('t2').className = n === 2 ? 'tab active' : 'tab';
        };

        // Cloud & WhatsApp (Unverändert wie gewünscht)
        window.host = () => {
            room = Math.random().toString(36).substr(2, 5).toUpperCase();
            set(ref(db, 'rooms/' + room), { state, settings: config, members: { [localStorage.getItem('es_uid')]: { name: document.getElementById('host-name').value || "Host", role: 'admin' } } });
            document.getElementById('disp-code').innerText = room;
            document.getElementById('active-view').style.display = 'block';
            onValue(ref(db, 'rooms/' + room), (snap) => { if(snap.exists()){ state = snap.val().state; config = snap.val().settings; render(); }});
        };

        render();
    </script>
</body>
</html>
