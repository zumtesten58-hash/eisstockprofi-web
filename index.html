<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eisstockprofi Pro</title>
    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #0a0a0a; --panel: #161616; }
        body { background-color: var(--bg); color: white; font-family: 'Inter', -apple-system, sans-serif; margin: 0; overflow: hidden; user-select: none; }
        
        /* Professional Header */
        .header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #000; border-bottom: 1px solid #222; }
        .btn-top { background: #222; border: 1px solid #444; color: #eee; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .header-title { text-align: center; flex-grow: 1; }
        .header-title h1 { font-size: 14px; margin: 0; letter-spacing: 2px; color: #fff; }
        .header-title span { font-size: 10px; color: var(--color-a); font-weight: bold; text-transform: uppercase; }

        /* Scoreboard */
        .main-container { display: flex; flex-direction: column; height: calc(100vh - 60px); }
        .scoreboard { display: flex; padding: 10px; gap: 10px; flex: 1; align-items: stretch; }
        .team-box { flex: 1; border: 2px solid; border-radius: 12px; background: var(--panel); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s; }
        .name-display { font-size: 14px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
        .score-display { font-size: 80px; font-weight: 900; line-height: 1; margin: 5px 0; }
        .points-display { font-size: 14px; font-weight: 600; opacity: 0.8; }

        /* Input Area */
        .controls { padding: 15px; display: flex; gap: 10px; }
        .btn-group { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .btn-p { padding: 15px; border: none; border-radius: 8px; color: white; font-weight: 800; font-size: 15px; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-p:active { transform: translateY(2px); box-shadow: none; }
        .btn-small { padding: 10px; font-size: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }

        /* Footer Nav */
        .footer-nav { padding: 15px; display: flex; justify-content: center; gap: 20px; background: #000; }
        .nav-item { background: none; border: none; color: #666; font-size: 11px; font-weight: bold; cursor: pointer; }
        .nav-item:active { color: #fff; }

        /* Modals & Overlays */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; backdrop-filter: blur(5px); }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: #1c1c1c; border-radius: 16px; padding: 25px; border: 1px solid #333; text-align: center; }
        .modal h2 { margin-top: 0; font-size: 18px; letter-spacing: 1px; }
        
        /* Settings Styles */
        .settings-content { height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .s-row { margin-bottom: 20px; text-align: left; }
        .s-label { font-size: 10px; font-weight: bold; color: #666; margin-bottom: 5px; display: block; }
        .s-input { width: 100%; background: #222; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; box-sizing: border-box; }
        .btn-save { width: 100%; padding: 15px; background: #28a745; border: none; color: white; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        .btn-factory { background: transparent; color: #ff4444; border: 1px solid #ff4444; margin-top: 30px; font-size: 10px; width: 100%; padding: 10px; border-radius: 8px; font-weight: bold; opacity: 0.6; }

        .live-tag { color: #00ff00 !important; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-top" onclick="confirmReset()">Neues Spiel</button>
        <div class="header-title">
            <h1>EISSTOCKPROFI PRO</h1>
            <span id="room-status">LOKAL</span>
        </div>
        <button class="btn-top" onclick="openSettings()">⚙️</button>
    </div>

    <div class="main-container">
        <div class="scoreboard">
            <div class="team-box" id="box-a" style="border-color: var(--color-a);">
                <div id="disp-na" class="name-display" style="color: var(--color-a);">Team A</div>
                <div id="val-ga" class="score-display">0</div>
                <div id="val-pa" class="points-display">PUNKTE: 0</div>
            </div>
            <div class="team-box" id="box-b" style="border-color: var(--color-b);">
                <div id="disp-nb" class="name-display" style="color: var(--color-b);">Team B</div>
                <div id="val-gb" class="score-display">0</div>
                <div id="val-pb" class="points-display">PUNKTE: 0</div>
            </div>
        </div>

        <div class="controls">
            <div class="btn-group">
                <button class="btn-p" style="background:var(--color-a)" onclick="addP('A', 6)">6 PKT (1. Stock)</button>
                <button class="btn-p" style="background:var(--color-a); opacity:0.8;" onclick="addP('A', 3)">+3 PKT</button>
                <button class="btn-p btn-small" onclick="addP('A', 1)">+1 PKT Feinjustierung</button>
            </div>
            <div class="btn-group">
                <button class="btn-p" style="background:var(--color-b)" onclick="addP('B', 6)">6 PKT (1. Stock)</button>
                <button class="btn-p" style="background:var(--color-b); opacity:0.8;" onclick="addP('B', 3)">+3 PKT</button>
                <button class="btn-p btn-small" onclick="addP('B', 1)">+1 PKT Feinjustierung</button>
            </div>
        </div>

        <div class="footer-nav">
            <button class="nav-item" onclick="historyStep(-1)">← KORREKTUR</button>
            <button class="nav-item" onclick="historyStep(1)">VORWÄRTS →</button>
        </div>
    </div>

    <div id="modal-overlay" class="overlay">
        <div class="modal" id="modal-box">
            <h2 id="m-title">Titel</h2>
            <p id="m-body" style="color:#aaa; font-size:14px;"></p>
            <div id="m-footer" style="display:flex; gap:10px; margin-top:20px;"></div>
        </div>
    </div>

    <div id="settings-overlay" class="overlay" style="background: #000;">
        <div class="settings-content">
            <h2 style="text-align:center; letter-spacing:2px;">EINSTELLUNGEN</h2>
            
            <div class="s-row">
                <label class="s-label">TEAM A NAME & FARBE</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="in-na" class="s-input" oninput="livePreview()">
                    <input type="color" id="in-ca" oninput="livePreview()" style="width:60px; height:45px; border:none; background:none;">
                </div>
            </div>

            <div class="s-row">
                <label class="s-label">TEAM B NAME & FARBE</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="in-nb" class="s-input" oninput="livePreview()">
                    <input type="color" id="in-cb" oninput="livePreview()" style="width:60px; height:45px; border:none; background:none;">
                </div>
            </div>

            <div class="s-row">
                <label class="s-label">SIEG BEI PUNKTZAHL</label>
                <input type="number" id="in-win" class="s-input" oninput="livePreview()">
            </div>

            <hr style="border:0; border-top:1px solid #222; margin:30px 0;">

            <div id="online-view">
                <label class="s-label">ONLINE MODUS</label>
                <div id="online-init">
                    <button class="btn-p" style="background:#444; width:100%; margin-bottom:10px;" onclick="hostGame()">GRUPPE HOSTEN</button>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="join-code" class="s-input" placeholder="CODE" style="flex:1">
                        <input type="text" id="join-name" class="s-input" placeholder="DEIN NAME" style="flex:2">
                    </div>
                    <button class="btn-save" style="background:#007bff" onclick="joinGame()">BEITRETEN</button>
                </div>
                <div id="online-active" style="display:none; text-align:center;">
                    <div style="font-size:10px; color:#666;">RAUM-CODE:</div>
                    <div id="active-code" style="font-size:32px; font-weight:900; color:var(--color-a);">----</div>
                    <button class="btn-top" onclick="shareWA()" style="background:#25D366; border:none; margin-top:10px;">WhatsApp Einladung</button>
                </div>
            </div>

            <div style="margin-top:40px; display:flex; flex-direction:column; gap:10px;">
                <button class="btn-save" onclick="saveSettings()">ÄNDERUNGEN SPEICHERN</button>
                <button class="btn-p btn-small" onclick="closeSettings()">ABBRECHEN (Zurück)</button>
                <button class="btn-factory" onclick="factoryReset()">AUF STANDARD ZURÜCKSETZEN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U",
            authDomain: "eisstock-live.firebaseapp.com",
            projectId: "eisstock-live",
            databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State & Local Data
        let config = JSON.parse(localStorage.getItem('es_v3_cfg')) || { na: "Team A", nb: "Team B", ca: "#00BFFF", cb: "#FF4500", win: 12, p1: 0.5, p3: 1.5 };
        let state = { ga: 0, pa: 0, gb: 0, pb: 0 };
        let history = [JSON.stringify(state)];
        let hIdx = 0;
        let room = null;
        let myRole = 'admin';
        let myId = localStorage.getItem('es_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('es_uid', myId);

        // Core Functions
        window.addP = (team, val) => {
            if(myRole === 'read') return;
            let n = JSON.parse(history[hIdx]);
            if(team === 'A') { n.pa += val; n.pb = 0; } else { n.pb += val; n.pa = 0; }
            
            checkWin(n);
            pushHistory(n);
        };

        function checkWin(n) {
            if(n.pa >= config.win || n.pb >= config.win) {
                const winA = n.pa >= config.win;
                const loP = winA ? n.pb : n.pa;
                const isSchneider = (loP === 0);
                
                let title = isSchneider ? "DREIFACH-SIEG (Schneider)" : "EINFACH-SIEG";
                let ratio = winA ? (isSchneider ? "3 : 0" : "2 : 1") : (isSchneider ? "0 : 3" : "1 : 2");
                let loser = winA ? config.nb : config.na;
                let price = isSchneider ? config.p3 : config.p1;

                if(winA) { n.ga += (isSchneider ? 3 : 2); if(!isSchneider) n.gb += 1; }
                else { n.gb += (isSchneider ? 3 : 2); if(!isSchneider) n.ga += 1; }

                showModal(title, `${ratio}<br><small>${loser} zahlt ${price.toFixed(2)}€</small>`, [
                    { label: "NÄCHSTE MOAR", cmd: "nextRound()", primary: true }
                ]);
                state = n;
            }
        }

        window.nextRound = () => {
            state.pa = 0; state.pb = 0;
            pushHistory(state);
            closeModal();
        };

        // UI Management
        function updateUI(data = state, cfg = config) {
            document.getElementById('val-ga').innerText = data.ga;
            document.getElementById('val-gb').innerText = data.gb;
            document.getElementById('val-pa').innerText = "PUNKTE: " + data.pa;
            document.getElementById('val-pb').innerText = "PUNKTE: " + data.pb;
            document.getElementById('disp-na').innerText = cfg.na;
            document.getElementById('disp-nb').innerText = cfg.nb;
            document.documentElement.style.setProperty('--color-a', cfg.ca);
            document.documentElement.style.setProperty('--color-b', cfg.cb);
            document.getElementById('disp-na').style.color = cfg.ca;
            document.getElementById('disp-nb').style.color = cfg.cb;
        }

        window.livePreview = () => {
            const previewCfg = {
                na: document.getElementById('in-na').value,
                nb: document.getElementById('in-nb').value,
                ca: document.getElementById('in-ca').value,
                cb: document.getElementById('in-cb').value,
                win: parseInt(document.getElementById('in-win').value)
            };
            updateUI(state, previewCfg);
        };

        window.saveSettings = () => {
            if(myRole !== 'admin') { showModal("ZUGRIFF VERWEIGERT", "Nur der Admin darf Einstellungen ändern.", [{label: "OK", cmd:"closeModal()"}]); return; }
            config.na = document.getElementById('in-na').value;
            config.nb = document.getElementById('in-nb').value;
            config.ca = document.getElementById('in-ca').value;
            config.cb = document.getElementById('in-cb').value;
            config.win = parseInt(document.getElementById('in-win').value);
            localStorage.setItem('es_v3_cfg', JSON.stringify(config));
            sync();
            closeSettings();
        };

        // Modal System
        window.showModal = (title, body, buttons) => {
            document.getElementById('m-title').innerText = title;
            document.getElementById('m-body').innerHTML = body;
            const footer = document.getElementById('m-footer');
            footer.innerHTML = "";
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.className = "btn-p";
                btn.style.flex = "1";
                btn.style.fontSize = "12px";
                btn.style.background = b.primary ? "#28a745" : "#444";
                btn.innerText = b.label;
                btn.onclick = () => eval(b.cmd);
                footer.appendChild(btn);
            });
            document.getElementById('modal-overlay').style.display = 'block';
        };
        window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';

        // Online Logic
        window.hostGame = () => {
            room = Math.random().toString(36).substr(2, 5).toUpperCase();
            myRole = 'admin';
            set(ref(db, 'rooms/' + room), { state, settings: config, members: { [myId]: { name: "Host", role: 'admin' } } });
            initOnlineMode();
        };

        window.joinGame = () => {
            const code = document.getElementById('join-code').value.toUpperCase();
            const name = document.getElementById('join-name').value;
            if(!code || !name) { showModal("FEHLER", "Bitte Code und Namen eingeben!", [{label:"OK", cmd:"closeModal()"}]); return; }
            onValue(ref(db, 'rooms/' + code), (snap) => {
                if(snap.exists()) {
                    room = code;
                    update(ref(db, `rooms/${code}/members/${myId}`), { name, role: 'read' });
                    initOnlineMode();
                } else showModal("NICHT GEFUNDEN", "Dieser Raum existiert nicht.", [{label:"OK", cmd:"closeModal()"}]);
            }, { onlyOnce: true });
        };

        function initOnlineMode() {
            document.getElementById('online-init').style.display = 'none';
            document.getElementById('online-active').style.display = 'block';
            document.getElementById('active-code').innerText = room;
            document.getElementById('room-status').innerText = "LIVE: " + room;
            document.getElementById('room-status').classList.add('live-tag');
            
            onValue(ref(db, 'rooms/' + room), (snap) => {
                const data = snap.val();
                if(data) {
                    state = data.state;
                    config = data.settings;
                    myRole = data.members[myId]?.role || 'read';
                    updateUI();
                }
            });
        }

        // Helpers
        function pushHistory(s) {
            history = history.slice(0, hIdx + 1);
            history.push(JSON.stringify(s));
            hIdx++;
            state = s;
            sync();
            updateUI();
        }

        window.historyStep = (dir) => {
            if(myRole === 'read') return;
            if(dir === -1 && hIdx > 0) hIdx--;
            if(dir === 1 && hIdx < history.length - 1) hIdx++;
            state = JSON.parse(history[hIdx]);
            sync(); updateUI();
        };

        window.confirmReset = () => {
            showModal("NEUES SPIEL?", "Möchtest du wirklich alle Punkte löschen?", [
                { label: "ABBRECHEN", cmd: "closeModal()" },
                { label: "JA, RESET", cmd: "doReset()", primary: true }
            ]);
        };

        window.doReset = () => {
            state = { ga: 0, pa: 0, gb: 0, pb: 0 };
            pushHistory(state);
            closeModal();
        };

        window.openSettings = () => {
            document.getElementById('in-na').value = config.na;
            document.getElementById('in-nb').value = config.nb;
            document.getElementById('in-ca').value = config.ca;
            document.getElementById('in-cb').value = config.cb;
            document.getElementById('in-win').value = config.win;
            document.getElementById('settings-overlay').style.display = 'block';
        };

        window.closeSettings = () => {
            document.getElementById('settings-overlay').style.display = 'none';
            updateUI(); // Reset visual changes if not saved
        };

        window.sync = () => { if(room && myRole === 'admin') update(ref(db, 'rooms/' + room), { state, settings: config }); };
        
        window.factoryReset = () => { localStorage.clear(); location.reload(); };

        window.shareWA = () => {
            const url = window.location.href.split('?')[0] + "?join=" + room;
            window.open(`https://wa.me/?text=${encodeURIComponent("Komm in meine Eisstock-Gruppe!\nCode: " + room + "\nLink: " + url)}`);
        };

        // URL Join Auto-Handler
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('join')) {
            const code = urlParams.get('join');
            setTimeout(() => {
                document.getElementById('join-code').value = code;
                openSettings();
                showModal("EINLADUNG", `Möchtest du der Gruppe ${code} beitreten? Gib deinen Namen ein.`, [
                    {label: "OK", cmd:"closeModal()"}
                ]);
            }, 500);
        }

        updateUI();
    </script>
</body>
</html>
