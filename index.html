<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eisstock Profi DELUXE Live</title>
    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #000; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; overflow: hidden; user-select: none; touch-action: manipulation; }
        
        .header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #111; border-bottom: 2px solid #333; }
        .btn-top { background: #222; border: 1px solid #444; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        
        .scoreboard { display: flex; gap: 10px; padding: 15px; height: 190px; }
        .team-card { flex: 1; border: 4px solid; border-radius: 25px; background: linear-gradient(145deg, #0f0f0f, #1a1a1a); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.3s; }
        .big-score { font-size: 90px; font-weight: 900; line-height: 1; margin: 5px 0; }
        .small-points { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

        .controls { display: flex; gap: 15px; padding: 0 15px 10px; }
        .btn-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .btn-stock { padding: 22px; border: none; border-radius: 15px; color: white; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 5px 0 rgba(0,0,0,0.5); }
        .btn-stock:active { transform: translateY(4px); box-shadow: none; }
        
        .nav-footer { display: flex; justify-content: center; gap: 15px; padding: 15px; }
        .btn-nav { background: #eee; color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: 900; flex: 1; font-size: 14px; cursor: pointer; }
        .btn-nav:disabled { opacity: 0.3; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; overflow-y: auto; }
        .tab-bar { display: flex; background: #111; border-bottom: 2px solid #333; position: sticky; top: 0; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #555; font-weight: bold; cursor: pointer; }
        .tab.active { color: var(--color-a); border-bottom: 4px solid var(--color-a); }
        .s-body { padding: 20px; padding-bottom: 80px; }
        .s-row { margin-bottom: 15px; }
        .s-label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .s-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        .btn-save { background: #28a745; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; }
        .btn-danger { background: #d9534f; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; }
        .btn-back-main { background: #333; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }

        .member-item { display: flex; align-items: center; justify-content: space-between; background: #111; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid #222; }

        .win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #0a0a0a; border: 5px solid red; border-radius: 30px; padding: 30px; text-align: center; z-index: 2000; }
        .win-overlay-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1999; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-top" onclick="resetGame()">NEU SPIEL</button>
        <div style="text-align:center">
            <h1 style="font-size:15px; margin:0;">EISSTOCK PROFI</h1>
            <div id="room-info" style="font-size:10px; color:var(--color-a); font-weight:bold;">LOKAL</div>
        </div>
        <button class="btn-top" onclick="openSettings()">⚙️ OPTIONEN</button>
    </div>

    <div class="scoreboard">
        <div class="team-card" id="card-a"><div id="disp-na" class="small-points">TEAM A</div><div id="val-ga" class="big-score">0</div><div id="val-pa" class="small-points">PUNKTE: 0</div></div>
        <div class="team-card" id="card-b"><div id="disp-nb" class="small-points">TEAM B</div><div id="val-gb" class="big-score">0</div><div id="val-pb" class="small-points">PUNKTE: 0</div></div>
    </div>

    <div class="controls">
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 4)">4 STÖCKE</button>
        </div>
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 4)">4 STÖCKE</button>
        </div>
    </div>

    <div class="nav-footer">
        <button class="btn-nav" id="undo" onclick="historyStep(-1)">← KORREKTUR</button>
        <button class="btn-nav" id="redo" onclick="historyStep(1)">VORWÄRTS →</button>
    </div>

    <div id="win-overlay-bg" class="win-overlay-bg"></div>
    <div id="win-modal" class="win-modal">
        <h2 id="win-label" style="color:red; margin:0; font-size:28px;">SIEG!</h2>
        <div id="win-score-display" style="font-size:60px; font-weight:900; margin:15px 0; color:white;">0 : 0</div>
        <p id="win-payment-text" style="font-size:20px; color:#00ff00; font-weight:bold; margin-bottom:25px;"></p>
        <button class="btn-save" onclick="closeWinAndReset()">NEUES SPIEL</button>
    </div>

    <div id="settings" class="overlay">
        <div class="tab-bar">
            <div id="t1" class="tab active" onclick="setTab(1)">ALLGEMEIN</div>
            <div id="t2" class="tab" onclick="setTab(2)">ONLINE-MODUS</div>
        </div>
        
        <div id="s1" class="s-body">
            <div class="s-row"><label class="s-label">Team A / Farbe</label><div style="display:flex; gap:10px;"><input id="set-na" class="s-input"><input type="color" id="set-ca" style="width:60px; height:45px;"></div></div>
            <div class="s-row"><label class="s-label">Team B / Farbe</label><div style="display:flex; gap:10px;"><input id="set-nb" class="s-input"><input type="color" id="set-cb" style="width:60px; height:45px;"></div></div>
            <div style="display:flex; gap:10px;">
                <div class="s-row" style="flex:1;"><label class="s-label">1. Stock</label><input type="number" id="set-p1" class="s-input"></div>
                <div class="s-row" style="flex:1;"><label class="s-label">Folgestock</label><input type="number" id="set-pn" class="s-input"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="s-row" style="flex:1;"><label class="s-label">Ziel-Pkt</label><input type="number" id="set-pw" class="s-input"></div>
                <div class="s-row" style="flex:1;"><label class="s-label">Sieg €</label><input type="number" id="set-pe" class="s-input" step="0.10"></div>
            </div>
            <div class="s-row"><label class="s-label">3:0 Preis €</label><input type="number" id="set-pe3" class="s-input" step="0.10"></div>
            <div class="s-row" style="background:#111; padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="set-reset" style="transform:scale(1.5);">
                <label class="s-label" style="margin:0;">Gegner bei Sieg auf 0</label>
            </div>
            <button class="btn-save" onclick="saveSettings()">SPEICHERN & ZURÜCK</button>
            <button class="btn-danger" onclick="resetToDefaults()">WERKSEINSTELLUNGEN</button>
            <button class="btn-back-main" onclick="closeSettings()">NUR ZURÜCK</button>
        </div>
        
        <div id="s2" class="s-body" style="display:none">
            <div id="online-setup">
                <label class="s-label">Dein Name</label><input id="user-name" class="s-input" placeholder="Name...">
                <button class="btn-save" style="margin-top:15px; background:var(--color-a);" onclick="hostGame()">NEUEN RAUM ERSTELLEN</button>
                <div style="display:flex; gap:10px; margin-top:10px;"><input id="join-code" class="s-input" placeholder="CODE"><button class="btn-top" style="background:#28a745" onclick="joinGame()">BEITRETEN</button></div>
            </div>
            <div id="online-active" style="display:none;">
                <h1 id="room-code-display" style="font-size:50px; color:#00ff00; text-align:center; margin:0;">-----</h1>
                <button onclick="shareWhatsApp()" style="width:100%; background:#25D366; color:white; border:none; padding:15px; border-radius:30px; font-weight:bold; margin:20px 0;">WhatsApp Einladung</button>
                <label class="s-label">MITGLIEDER</label>
                <div id="member-list"></div>
                <button class="btn-save" onclick="closeSettings()" style="margin-top:20px;">ZURÜCK ZUM SPIEL</button>
                <button class="btn-danger" onclick="leaveRoom()">RAUM VERLASSEN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U", authDomain: "eisstock-live.firebaseapp.com", projectId: "eisstock-live", databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const DEFAULTS = { na:"Team A", nb:"Team B", ca:"#00BFFF", cb:"#FF4500", p1:6, pn:3, pw:12, pe:0.50, pe3:1.50, reset:true };
        let config = JSON.parse(localStorage.getItem('es_final_v2')) || {...DEFAULTS};
        
        let state = { ga:0, pa:0, gb:0, pb:0, win: false, day: new Date().getDate() };
        let room = localStorage.getItem('es_current_room');
        let myId = localStorage.getItem('es_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('es_uid', myId);

        // History für Lokal-Modus
        let history = [JSON.stringify(state)];
        let hIdx = 0;

        window.addStock = (team, count) => {
            if(navigator.vibrate) navigator.vibrate(50);
            let n = {...state};
            
            if(team === 'A') {
                let p = (n.pa === 0) ? parseInt(config.p1) + (count-1)*parseInt(config.pn) : count*parseInt(config.pn);
                n.pa += p;
                if(n.pa >= config.pw) { n.ga++; n.pa = 0; if(config.reset) n.pb = 0; }
            } else {
                let p = (n.pb === 0) ? parseInt(config.p1) + (count-1)*parseInt(config.pn) : count*parseInt(config.pn);
                n.pb += p;
                if(n.pb >= config.pw) { n.gb++; n.pb = 0; if(config.reset) n.pa = 0; }
            }
            
            if(n.ga >= 3 || n.gb >= 3) n.win = true;
            broadcast(n);
        };

        function broadcast(newState) {
            if(room) {
                update(ref(db, 'rooms/' + room), { state: newState });
            } else {
                state = newState;
                history = history.slice(0, hIdx + 1);
                history.push(JSON.stringify(state));
                hIdx++;
                render();
            }
        }

        window.historyStep = (dir) => {
            if(room) return alert("Korrektur im Online-Modus bitte über Neu Spiel.");
            if(dir === -1 && hIdx > 0) hIdx--;
            if(dir === 1 && hIdx < history.length - 1) hIdx++;
            state = JSON.parse(history[hIdx]);
            render();
        };

        function render() {
            document.getElementById('val-ga').innerText = state.ga;
            document.getElementById('val-gb').innerText = state.gb;
            document.getElementById('val-pa').innerText = "PUNKTE: " + state.pa;
            document.getElementById('val-pb').innerText = "PUNKTE: " + state.pb;
            document.getElementById('disp-na').innerText = config.na;
            document.getElementById('disp-nb').innerText = config.nb;
            document.getElementById('card-a').style.borderColor = config.ca;
            document.getElementById('card-b').style.borderColor = config.cb;
            document.documentElement.style.setProperty('--color-a', config.ca);
            document.documentElement.style.setProperty('--color-b', config.cb);
            
            // Sieg Fenster Logik
            if(state.win) {
                const winner = state.ga >= 3 ? config.na : config.nb;
                const isTriple = (state.ga === 3 && state.gb === 0) || (state.gb === 3 && state.ga === 0);
                const price = isTriple ? config.pe3 : config.pe;
                document.getElementById('win-label').innerText = winner + " GEWINNT!";
                document.getElementById('win-score-display').innerText = `${state.ga} : ${state.gb}`;
                document.getElementById('win-payment-text').innerText = `Verlierer zahlt ${price.toFixed(2)} €` + (isTriple ? " (3:0!)" : "");
                document.getElementById('win-overlay-bg').style.display = 'block';
                document.getElementById('win-modal').style.display = 'block';
            } else {
                document.getElementById('win-overlay-bg').style.display = 'none';
                document.getElementById('win-modal').style.display = 'none';
            }
        }

        window.resetGame = () => {
            broadcast({ ga:0, pa:0, gb:0, pb:0, win: false, day: new Date().getDate() });
        };

        window.resetToDefaults = () => {
            if(confirm("Alle Einstellungen löschen und auf Werkseinstellungen zurücksetzen?")) {
                config = {...DEFAULTS};
                localStorage.setItem('es_final_v2', JSON.stringify(config));
                saveSettings();
            }
        };

        window.openSettings = () => {
            document.getElementById('set-na').value = config.na;
            document.getElementById('set-nb').value = config.nb;
            document.getElementById('set-ca').value = config.ca;
            document.getElementById('set-cb').value = config.cb;
            document.getElementById('set-p1').value = config.p1;
            document.getElementById('set-pn').value = config.pn;
            document.getElementById('set-pw').value = config.pw;
            document.getElementById('set-pe').value = config.pe;
            document.getElementById('set-pe3').value = config.pe3;
            document.getElementById('set-reset').checked = config.reset;
            document.getElementById('settings').style.display = 'block';
        };

        window.saveSettings = () => {
            config.na = document.getElementById('set-na').value;
            config.nb = document.getElementById('set-nb').value;
            config.ca = document.getElementById('set-ca').value;
            config.cb = document.getElementById('set-cb').value;
            config.p1 = parseInt(document.getElementById('set-p1').value);
            config.pn = parseInt(document.getElementById('set-pn').value);
            config.pw = parseInt(document.getElementById('set-pw').value);
            config.pe = parseFloat(document.getElementById('set-pe').value);
            config.pe3 = parseFloat(document.getElementById('set-pe3').value);
            config.reset = document.getElementById('set-reset').checked;
            localStorage.setItem('es_final_v2', JSON.stringify(config));
            if(room) update(ref(db, 'rooms/' + room), { settings: config });
            closeSettings();
            render();
        };

        window.closeSettings = () => { document.getElementById('settings').style.display = 'none'; };

        window.hostGame = () => {
            const name = document.getElementById('user-name').value;
            if(!name) return alert("Name?");
            const newRoom = Math.random().toString(36).substr(2, 5).toUpperCase();
            set(ref(db, 'rooms/' + newRoom), { 
                state, 
                settings: config, 
                members: { [myId]: { name } } 
            }).then(() => {
                room = newRoom;
                localStorage.setItem('es_current_room', room);
                localStorage.setItem('es_user_name', name);
                initSession();
            });
        };

        window.joinGame = (forcedCode) => {
            const name = document.getElementById('user-name').value || "Spieler";
            const c = forcedCode || document.getElementById('join-code').value.toUpperCase();
            if(!c) return;
            update(ref(db, `rooms/${c}/members/${myId}`), { name }).then(() => {
                room = c;
                localStorage.setItem('es_current_room', room);
                localStorage.setItem('es_user_name', name);
                initSession();
            });
        };

        function initSession() {
            if(!room) return;
            document.getElementById('online-setup').style.display = 'none';
            document.getElementById('online-active').style.display = 'block';
            document.getElementById('room-code-display').innerText = room;
            document.getElementById('room-info').innerText = "ONLINE: " + room;

            onValue(ref(db, 'rooms/' + room), (snap) => {
                const data = snap.val();
                if(!data) return;

                // 24h Auto-Reset Check
                const today = new Date().getDate();
                if(data.state.day !== today) {
                    if(myId === Object.keys(data.members)[0]) { // Nur der erste löscht
                        remove(ref(db, 'rooms/' + room));
                        leaveRoom();
                    }
                    return;
                }

                state = data.state;
                config = data.settings;
                render();
                
                const mList = document.getElementById('member-list');
                mList.innerHTML = "";
                Object.values(data.members || {}).forEach(m => {
                    mList.innerHTML += `<div class="member-item"><span>${m.name}</span> <span style="font-size:10px; color:#666;">BEREIT</span></div>`;
                });
            });
        }

        window.leaveRoom = () => {
            if(room) remove(ref(db, `rooms/${room}/members/${myId}`));
            localStorage.removeItem('es_current_room');
            location.reload();
        };

        window.shareWhatsApp = () => {
            const url = window.location.href.split('?')[0] + "?join=" + room;
            const text = `Komm in meinen Eisstock-Raum! Klicke hier um beizutreten: ${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        };

        window.setTab = (n) => {
            document.getElementById('s1').style.display = n === 1 ? 'block' : 'none';
            document.getElementById('s2').style.display = n === 2 ? 'block' : 'none';
            document.getElementById('t1').className = n === 1 ? 'tab active' : 'tab';
            document.getElementById('t2').className = n === 2 ? 'tab active' : 'tab';
        };

        // Deep Link Check beim Start
        const urlParams = new URLSearchParams(window.location.search);
        const joinParam = urlParams.get('join');
        if(joinParam) {
            document.getElementById('user-name').value = localStorage.getItem('es_user_name') || "";
            setTimeout(() => { joinGame(joinParam); }, 500);
        } else if(room) {
            initSession();
        }

        render();
    </script>
</body>
</html>
