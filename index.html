<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eisstockprofi Pro</title>
    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #000000; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        
        /* Header Bereich */
        .header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #111; border-bottom: 2px solid #222; }
        .btn-new { background: #333; border: 1px solid #555; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold; font-size: 12px; cursor: pointer; }
        .header-center { text-align: center; }
        .header-center h1 { font-size: 16px; margin: 0; letter-spacing: 1px; }
        .group-name { font-size: 11px; color: var(--color-a); font-weight: bold; }

        /* Scoreboard (Anlehnung an deine App) */
        .scoreboard { display: flex; gap: 10px; padding: 15px; height: 180px; }
        .team-card { flex: 1; border: 3px solid; border-radius: 20px; background: #0a0a0a; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .team-label { font-size: 14px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; }
        .big-score { font-size: 85px; font-weight: 900; line-height: 1; }
        .points-label { font-size: 13px; font-weight: bold; margin-top: 5px; opacity: 0.8; }

        /* Stöcke Buttons */
        .input-grid { display: flex; gap: 15px; padding: 0 15px 15px 15px; }
        .btn-col { flex: 1; display: flex; flex-direction: column; gap: 12px; }
        .btn-stock { padding: 20px; border: none; border-radius: 12px; color: white; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 4px #000; }
        .btn-stock:active { transform: translateY(2px); box-shadow: none; }

        /* Navigation Unten */
        .nav-footer { display: flex; justify-content: center; gap: 20px; padding: 20px; background: #000; }
        .btn-nav { background: white; color: black; border: none; padding: 15px 25px; border-radius: 8px; font-weight: 900; font-size: 14px; flex: 1; max-width: 150px; }
        .btn-nav:disabled { opacity: 0.3; }

        /* Overlays & Settings */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; overflow-y: auto; }
        .tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #666; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--color-a); border-bottom-color: var(--color-a); }
        
        .settings-body { padding: 20px; }
        .s-group { margin-bottom: 20px; }
        .s-group label { display: block; font-size: 11px; color: #888; font-weight: bold; margin-bottom: 5px; }
        .s-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .footer-save { position: sticky; bottom: 0; padding: 20px; background: black; border-top: 1px solid #222; display: flex; flex-direction: column; gap: 10px; }
        .btn-save { background: #28a745; color: white; border: none; padding: 18px; border-radius: 10px; font-weight: bold; font-size: 16px; }
        .btn-cancel { background: #333; color: #ccc; border: none; padding: 12px; border-radius: 10px; }
        .btn-factory { color: #ff4444; background: none; border: 1px solid #ff4444; padding: 8px; font-size: 10px; margin-top: 20px; border-radius: 5px; opacity: 0.6; }

        /* Sieg Modal */
        .win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #111; border: 3px solid var(--color-a); border-radius: 20px; padding: 30px; text-align: center; z-index: 2000; }
        .win-title { font-size: 24px; font-weight: 900; margin-bottom: 10px; }
        .win-stats { font-size: 40px; font-weight: 900; color: var(--color-a); margin: 15px 0; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-new" onclick="resetPoints()">Neues Spiel</button>
        <div class="header-center">
            <h1>EISSTOCKPROFI PRO</h1>
            <div id="room-display" class="group-name">LOKAL</div>
        </div>
        <button class="btn-new" onclick="openSettings()">⚙️</button>
    </div>

    <div class="scoreboard">
        <div class="team-card" id="card-a" style="border-color: var(--color-a);">
            <div id="name-a-view" class="team-label" style="color: var(--color-a);">Team A</div>
            <div id="val-ga" class="big-score">0</div>
            <div id="val-pa" class="points-label">PUNKTE: 0</div>
        </div>
        <div class="team-card" id="card-b" style="border-color: var(--color-b);">
            <div id="name-b-view" class="team-label" style="color: var(--color-b);">Team B</div>
            <div id="val-gb" class="big-score">0</div>
            <div id="val-pb" class="points-label">PUNKTE: 0</div>
        </div>
    </div>

    <div class="input-grid">
        <div class="btn-col">
            <button class="btn-stock" style="background: var(--color-a);" onclick="stockScore('A', 1)">1 STOCK</button>
            <button class="btn-stock" style="background: var(--color-a);" onclick="stockScore('A', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background: var(--color-a);" onclick="stockScore('A', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background: var(--color-a);" onclick="stockScore('A', 4)">4 STÖCKE</button>
        </div>
        <div class="btn-col">
            <button class="btn-stock" style="background: var(--color-b);" onclick="stockScore('B', 1)">1 STOCK</button>
            <button class="btn-stock" style="background: var(--color-b);" onclick="stockScore('B', 2)">2 STÖCKE</button>
            <button class="btn-stock" style="background: var(--color-b);" onclick="stockScore('B', 3)">3 STÖCKE</button>
            <button class="btn-stock" style="background: var(--color-b);" onclick="stockScore('B', 4)">4 STÖCKE</button>
        </div>
    </div>

    <div class="nav-footer">
        <button class="btn-nav" id="btn-undo" onclick="hist(-1)">KORREKTUR</button>
        <button class="btn-nav" id="btn-redo" onclick="hist(1)">VORWÄRTS</button>
    </div>

    <div id="win-overlay" class="overlay" style="background: rgba(0,0,0,0.85);">
        <div class="win-modal">
            <div id="win-type" class="win-title">EINFACHSIEG</div>
            <div id="win-ratio" class="win-stats">2 : 1</div>
            <div id="win-pay" style="margin-bottom: 25px; color: #aaa;"></div>
            <button class="btn-save" style="width: 100%;" onclick="closeWin()">NÄCHSTE MOAR</button>
        </div>
    </div>

    <div id="settings-overlay" class="overlay">
        <div class="tabs">
            <div class="tab active" id="tab-gen" onclick="switchTab('gen')">ALLGEMEIN</div>
            <div class="tab" id="tab-onl" onclick="switchTab('onl')">ONLINE-MODUS</div>
        </div>

        <div id="view-gen" class="settings-body">
            <div class="s-group">
                <label>TEAM A: NAME & FARBE</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="set-na" class="s-input" oninput="preview()">
                    <input type="color" id="set-ca" oninput="preview()" style="width:70px; height:45px; border:none; background:none;">
                </div>
            </div>
            <div class="s-group">
                <label>TEAM B: NAME & FARBE</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="set-nb" class="s-input" oninput="preview()">
                    <input type="color" id="set-cb" oninput="preview()" style="width:70px; height:45px; border:none; background:none;">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="s-group" style="flex:1"><label>1. STOCK PKT.</label><input type="number" id="set-p1" class="s-input"></div>
                <div class="s-group" style="flex:1"><label>WEITERE STÖCKE</label><input type="number" id="set-pn" class="s-input"></div>
            </div>
            <div class="s-group">
                <label>MOAR-SIEG BEI PUNKTE (Z.B. 12)</label>
                <input type="number" id="set-win" class="s-input">
            </div>
        </div>

        <div id="view-onl" class="settings-body" style="display:none">
            <div id="onl-off">
                <input type="text" id="my-name" class="s-input" placeholder="Dein Name" style="margin-bottom:10px;">
                <button class="btn-save" style="width:100%; background:#444;" onclick="host()">GRUPPE HOSTEN</button>
                <div style="text-align:center; margin:15px; color:#555;">— ODER —</div>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="join-code" class="s-input" placeholder="CODE" style="flex:1; text-transform:uppercase;">
                    <input type="text" id="join-name" class="s-input" placeholder="DEIN NAME" style="flex:2;">
                </div>
                <button class="btn-save" style="width:100%; background:var(--color-a);" onclick="join()">BEITRETEN</button>
            </div>
            <div id="onl-on" style="display:none; text-align:center;">
                <div style="background:#111; padding:20px; border-radius:15px; border:1px solid #333;">
                    <div style="font-size:10px; color:#666;">RAUM-CODE</div>
                    <div id="disp-code" style="font-size:32px; font-weight:900; color:#00ff00; letter-spacing:3px;">-----</div>
                    <button onclick="share()" style="background:#25D366; color:white; border:none; padding:10px 20px; border-radius:20px; margin-top:10px; font-weight:bold;">WhatsApp Code senden</button>
                </div>
                <div id="admin-panel" style="margin-top:20px; text-align:left; display:none;">
                    <label style="font-size:10px; color:var(--color-a);">MITGLIEDER VERWALTEN:</label>
                    <div id="user-list"></div>
                </div>
                <button class="btn-factory" onclick="location.reload()">VERBINDUNG TRENNEN</button>
            </div>
        </div>

        <div class="footer-save">
            <button class="btn-save" onclick="applySettings()">ÄNDERUNGEN SPEICHERN</button>
            <button class="btn-cancel" onclick="closeSettings()">ABBRECHEN</button>
            <button class="btn-factory" onclick="factoryReset()">AUF STANDARD ZURÜCKSETZEN</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U",
            authDomain: "eisstock-live.firebaseapp.com",
            projectId: "eisstock-live",
            databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State & Settings
        let s = JSON.parse(localStorage.getItem('es_pro_s')) || { na:"Team A", nb:"Team B", ca:"#00BFFF", cb:"#FF4500", p1:6, pn:3, win:12 };
        let state = { ga:0, pa:0, gb:0, pb:0 };
        let history = [JSON.stringify(state)];
        let hIdx = 0;
        let room = null;
        let myId = localStorage.getItem('es_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('es_uid', myId);
        let myRole = 'admin';

        const vib = () => { if(navigator.vibrate) navigator.vibrate(60); };

        // Punktelogik (Original wie gewollt)
        window.stockScore = (team, stocks) => {
            if(myRole === 'read') return;
            vib();
            let n = JSON.parse(history[hIdx]);
            
            // Punktewert berechnen: 1. Stock = p1, jeder weitere +pn
            let earned = s.p1 + (stocks - 1) * s.pn;
            
            if(team === 'A') { n.pa += earned; n.pb = 0; } 
            else { n.pb += earned; n.pa = 0; }

            // Sieg-Check
            if(n.pa >= s.win || n.pb >= s.win) {
                const winA = n.pa >= s.win;
                const loP = winA ? n.pb : n.pa;
                const isDrei = (loP === 0);
                
                let type = isDrei ? "DreifachSieg" : "EinfachSieg";
                let ratio = winA ? (isDrei ? "3 : 0" : "2 : 1") : (isDrei ? "0 : 3" : "1 : 2");
                
                if(winA) { n.ga += (isDrei ? 3 : 2); if(!isDrei) n.gb += 1; }
                else { n.gb += (isDrei ? 3 : 2); if(!isDrei) n.ga += 1; }

                document.getElementById('win-type').innerText = type;
                document.getElementById('win-ratio').innerText = ratio;
                document.getElementById('win-pay').innerText = (winA ? s.nb : s.na) + " zahlt die Runde.";
                document.getElementById('win-overlay').style.display = 'block';
                state = n;
            }
            saveState(n);
        };

        window.closeWin = () => {
            document.getElementById('win-overlay').style.display = 'none';
            state.pa = 0; state.pb = 0;
            saveState(state);
        };

        window.resetPoints = () => {
            state = { ga:0, pa:0, gb:0, pb:0 };
            saveState(state);
            vib();
        };

        // UI & Settings
        function updateUI(st = state, cfg = s) {
            document.getElementById('val-ga').innerText = st.ga;
            document.getElementById('val-gb').innerText = st.gb;
            document.getElementById('val-pa').innerText = "PUNKTE: " + st.pa;
            document.getElementById('val-pb').innerText = "PUNKTE: " + st.pb;
            document.getElementById('name-a-view').innerText = cfg.na;
            document.getElementById('name-b-view').innerText = cfg.nb;
            document.documentElement.style.setProperty('--color-a', cfg.ca);
            document.documentElement.style.setProperty('--color-b', cfg.cb);
            document.getElementById('name-a-view').style.color = cfg.ca;
            document.getElementById('name-b-view').style.color = cfg.cb;
            
            document.getElementById('btn-undo').disabled = (hIdx <= 0 || myRole === 'read');
            document.getElementById('btn-redo').disabled = (hIdx >= history.length - 1 || myRole === 'read');
            document.querySelectorAll('.btn-stock').forEach(b => b.disabled = (myRole === 'read'));
        }

        window.preview = () => {
            const p = { na: document.getElementById('set-na').value, nb: document.getElementById('set-nb').value, ca: document.getElementById('set-ca').value, cb: document.getElementById('set-cb').value };
            updateUI(state, {...s, ...p});
        };

        window.applySettings = () => {
            if(myRole !== 'admin') return;
            s = {
                na: document.getElementById('set-na').value,
                nb: document.getElementById('set-nb').value,
                ca: document.getElementById('set-ca').value,
                cb: document.getElementById('set-cb').value,
                p1: parseInt(document.getElementById('set-p1').value),
                pn: parseInt(document.getElementById('set-pn').value),
                win: parseInt(document.getElementById('set-win').value)
            };
            localStorage.setItem('es_pro_s', JSON.stringify(s));
            sync(); closeSettings();
        };

        window.openSettings = () => {
            document.getElementById('set-na').value = s.na; document.getElementById('set-nb').value = s.nb;
            document.getElementById('set-ca').value = s.ca; document.getElementById('set-cb').value = s.cb;
            document.getElementById('set-p1').value = s.p1; document.getElementById('set-pn').value = s.pn;
            document.getElementById('set-win').value = s.win;
            document.getElementById('settings-overlay').style.display = 'block';
        };
        window.closeSettings = () => { document.getElementById('settings-overlay').style.display = 'none'; updateUI(); };
        window.switchTab = (t) => {
            document.getElementById('view-gen').style.display = t === 'gen' ? 'block' : 'none';
            document.getElementById('view-onl').style.display = t === 'onl' ? 'block' : 'none';
            document.getElementById('tab-gen').className = t === 'gen' ? 'tab active' : 'tab';
            document.getElementById('tab-onl').className = t === 'onl' ? 'tab active' : 'tab';
        };

        // Online Modus
        window.host = () => {
            const name = document.getElementById('my-name').value || "Host";
            room = Math.random().toString(36).substr(2, 5).toUpperCase();
            myRole = 'admin';
            set(ref(db, 'rooms/' + room), { state, settings: s, members: { [myId]: { name, role: 'admin' } } });
            startOnline();
        };

        window.join = () => {
            const code = document.getElementById('join-code').value.toUpperCase();
            const name = document.getElementById('join-name').value;
            if(!code || !name) return;
            onValue(ref(db, 'rooms/' + code), (snap) => {
                if(snap.exists()) {
                    room = code;
                    update(ref(db, `rooms/${code}/members/${myId}`), { name, role: 'read' });
                    startOnline();
                } else alert("Code nicht gültig!");
            }, { onlyOnce: true });
        };

        function startOnline() {
            document.getElementById('onl-off').style.display = 'none';
            document.getElementById('onl-on').style.display = 'block';
            document.getElementById('disp-code').innerText = room;
            document.getElementById('room-display').innerText = "LIVE: " + room;
            
            onValue(ref(db, 'rooms/' + room), (snap) => {
                const data = snap.val();
                if(!data) return;
                state = data.state; s = data.settings;
                myRole = data.members[myId]?.role || 'read';
                updateUI();
                if(myRole === 'admin') {
                    document.getElementById('admin-panel').style.display = 'block';
                    renderUsers(data.members);
                }
            });
        }

        function renderUsers(members) {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            for(let id in members) {
                if(id === myId) continue;
                const m = members[id];
                const div = document.createElement('div');
                div.style = "display:flex; justify-content:space-between; background:#222; padding:10px; margin-top:5px; border-radius:8px;";
                div.innerHTML = `<span>${m.name}</span>
                    <select onchange="changeRole('${id}', this.value)" style="background:#000; color:white; border:none;">
                        <option value="read" ${m.role==='read'?'selected':''}>Zuschauer</option>
                        <option value="write" ${m.role==='write'?'selected':''}>Schreiber</option>
                        <option value="admin" ${m.role==='admin'?'selected':''}>Admin</option>
                    </select>`;
                list.appendChild(div);
            }
        }

        window.changeRole = (uid, role) => { update(ref(db, `rooms/${room}/members/${uid}`), { role }); };
        window.share = () => { window.open(`https://wa.me/?text=${encodeURIComponent("Komm in meine Eisstock-Gruppe!\nCode: " + room + "\nLink: " + window.location.href.split('?')[0] + "?join=" + room)}`); };

        // History & Sync
        function saveState(n) {
            history = history.slice(0, hIdx + 1);
            history.push(JSON.stringify(n));
            hIdx++;
            state = n;
            sync(); updateUI();
        }

        window.hist = (dir) => {
            if(myRole === 'read') return;
            if(dir === -1 && hIdx > 0) hIdx--;
            if(dir === 1 && hIdx < history.length - 1) hIdx++;
            state = JSON.parse(history[hIdx]);
            sync(); updateUI();
        };

        function sync() { if(room && myRole === 'admin') update(ref(db, 'rooms/' + room), { state, settings: s }); }
        window.factoryReset = () => { localStorage.clear(); location.reload(); };

        // Auto-Join Link
        const urlP = new URLSearchParams(window.location.search);
        if(urlP.has('join')) {
            document.getElementById('join-code').value = urlP.get('join');
            openSettings(); switchTab('onl');
        }

        updateUI();
    </script>
</body>
</html>
