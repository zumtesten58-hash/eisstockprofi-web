<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Eisstockprofi Live</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; }
        body { background-color: black; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 10px; user-select: none; -webkit-user-select: none; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .btn-reset { background: #B22222; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; }
        .status-badge { font-size: 12px; padding: 4px 8px; border-radius: 10px; background: #333; }
        .live-active { background: #228B22; color: white; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        .scoreboard { display: flex; justify-content: space-around; margin-top: 15px; }
        .score-card { border: 3px solid; border-radius: 12px; width: 45%; padding: 10px; background: #1A1A1A; }
        #card-a { border-color: var(--color-a); }
        #card-b { border-color: var(--color-b); }
        .points-big { font-size: 60px; font-weight: 900; margin: 5px 0; }
        
        .input-area { display: flex; justify-content: space-around; margin-top: 20px; }
        .input-column { display: flex; flex-direction: column; width: 45%; }
        .btn-stock { margin: 5px; padding: 15px; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; color: white; cursor: pointer; }
        .stock-a { background: var(--color-a); }
        .stock-b { background: var(--color-b); }
        .btn-stock:disabled { opacity: 0.2; }
        
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        .btn-nav { background: #E0E0E0; color: black; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 48%; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #111; color: white; border: 1px solid #444; border-radius: 8px; box-sizing: border-box; }
        
        .btn-primary { background: #00BFFF; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; }
        .btn-secondary { background: #333; color: white; border: none; padding: 10px; width: 100%; border-radius: 10px; margin-top: 10px; }
        
        .role-selector { display: flex; gap: 5px; margin-bottom: 20px; }
        .role-btn { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        .role-active { background: #00BFFF; border-color: white; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-reset" onclick="handleReset()" id="reset-btn">↺ RESET</button>
        <div id="live-indicator" class="status-badge">LOKALER MODUS</div>
        <button style="background:none; border:none; font-size:24px; color:white;" onclick="openSettings()">⚙️</button>
    </div>

    <div class="scoreboard">
        <div class="score-card" id="card-a">
            <div id="display-team-a" style="font-weight:bold; color: var(--color-a);">Team A</div>
            <div id="games-a" class="points-big">0</div>
            <div id="partial-a">TEIL: 0</div>
        </div>
        <div class="score-card" id="card-b">
            <div id="display-team-b" style="font-weight:bold; color: var(--color-b);">Team B</div>
            <div id="games-b" class="points-big">0</div>
            <div id="partial-b">TEIL: 0</div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-column">
            <button class="btn-stock stock-a action-btn" onclick="addPoints('A', 1)">1 Stock</button>
            <button class="btn-stock stock-a action-btn" onclick="addPoints('A', 2)">2 Stöcke</button>
            <button class="btn-stock stock-a action-btn" onclick="addPoints('A', 3)">3 Stöcke</button>
            <button class="btn-stock stock-a action-btn" onclick="addPoints('A', 4)">4 Stöcke</button>
        </div>
        <div class="input-column">
            <button class="btn-stock stock-b action-btn" onclick="addPoints('B', 1)">1 Stock</button>
            <button class="btn-stock stock-b action-btn" onclick="addPoints('B', 2)">2 Stöcke</button>
            <button class="btn-stock stock-b action-btn" onclick="addPoints('B', 3)">3 Stöcke</button>
            <button class="btn-stock stock-b action-btn" onclick="addPoints('B', 4)">4 Stöcke</button>
        </div>
    </div>

    <div class="nav-buttons">
        <button class="btn-nav action-btn" onclick="undo()">← KORREKTUR</button>
        <button class="btn-nav action-btn" onclick="redo()">VORWÄRTS →</button>
    </div>

    <div id="settings-screen" class="overlay">
        <h2>LIVE-EINSTELLUNGEN</h2>
        <div id="live-setup">
            <label>Raum-Code (leer lassen für Auto-Code):</label>
            <input type="text" id="room-code" placeholder="Z.B. STOCK1">
            <label>Deine Rolle:</label>
            <div class="role-selector">
                <button class="role-btn role-active" id="btn-admin" onclick="updateRole('admin')">ADMIN</button>
                <button class="role-btn" id="btn-write" onclick="updateRole('write')">SCHREIBER</button>
                <button class="role-btn" id="btn-read" onclick="updateRole('read')">ZUSCHAUER</button>
            </div>
            <button class="btn-primary" onclick="initLiveMode()">LIVE-MODUS STARTEN</button>
        </div>
        
        <div id="live-info" style="display:none; margin-top:10px;">
            <p>Verbunden mit Raum: <b id="room-id-display"></b></p>
            <button class="btn-secondary" onclick="location.reload()">Raum verlassen / Trennen</button>
        </div>

        <hr style="margin:20px 0; border:0.5px solid #333;">
        
        <div id="admin-settings">
            <label>Team Namen:</label>
            <input type="text" id="set-name-a" placeholder="Team A">
            <input type="text" id="set-name-b" placeholder="Team B">
            <label>Farbe A & B:</label>
            <div style="display:flex; gap:10px;">
                <input type="color" id="set-color-a">
                <input type="color" id="set-color-b">
            </div>
        </div>

        <button class="btn-primary" style="margin-top:20px;" onclick="saveLocalSettings()">SPEICHERN & SCHLIESSEN</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U",
            authDomain: "eisstock-live.firebaseapp.com",
            projectId: "eisstock-live",
            storageBucket: "eisstock-live.firebasestorage.app",
            messagingSenderId: "201538137304",
            appId: "1:201538137304:web:78362c30c45c006cb63bad",
            databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let settings = { teamA: "Team A", teamB: "Team B", colorA: "#00BFFF", colorB: "#FF4500", p1: 6, pNext: 3, pWin: 12, betN: 0.5, betC: 1.5 };
        let history = [{ga:0, pa:0, gb:0, pb:0}];
        let currentIndex = 0;
        let currentRoom = null;
        let myRole = 'admin';

        window.updateRole = (r) => {
            myRole = r;
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('role-active'));
            document.getElementById('btn-' + r).classList.add('role-active');
        };

        window.initLiveMode = () => {
            let code = document.getElementById('room-code').value.trim().toUpperCase();
            if(!code) code = "ST-" + Math.random().toString(36).substring(2, 6).toUpperCase();
            currentRoom = code;
            
            onValue(ref(db, 'rooms/' + currentRoom), (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    settings = data.settings;
                    history = data.history;
                    currentIndex = data.currentIndex;
                    updateUI();
                } else if(myRole === 'admin') {
                    pushData();
                }
            });

            document.getElementById('live-setup').style.display = 'none';
            document.getElementById('live-info').style.display = 'block';
            document.getElementById('room-id-display').innerText = currentRoom;
            document.getElementById('live-indicator').innerText = "LIVE: " + currentRoom;
            document.getElementById('live-indicator').classList.add('live-active');
        };

        function pushData() {
            if(currentRoom && myRole !== 'read') {
                set(ref(db, 'rooms/' + currentRoom), { settings, history, currentIndex });
            }
        }

        window.addPoints = (team, stocks) => {
            if(myRole === 'read') return;
            let last = history[currentIndex];
            let next = {...last};
            let earned = (team === 'A' ? next.pa : next.pb) === 0 ? settings.p1 + (stocks-1)*settings.pNext : stocks*settings.pNext;
            
            if(team === 'A') {
                next.pa += earned;
                if(next.pa >= settings.pWin) { next.ga++; next.pa = 0; next.pb = 0; }
            } else {
                next.pb += earned;
                if(next.pb >= settings.pWin) { next.gb++; next.pa = 0; next.pb = 0; }
            }
            history = history.slice(0, currentIndex + 1);
            history.push(next);
            currentIndex++;
            pushData();
            updateUI();
        };

        window.updateUI = () => {
            const cur = history[currentIndex];
            document.getElementById('games-a').innerText = cur.ga;
            document.getElementById('games-b').innerText = cur.gb;
            document.getElementById('partial-a').innerText = "TEIL: " + cur.pa;
            document.getElementById('partial-b').innerText = "TEIL: " + cur.pb;
            document.getElementById('display-team-a').innerText = settings.teamA;
            document.getElementById('display-team-b').innerText = settings.teamB;
            document.documentElement.style.setProperty('--color-a', settings.colorA);
            document.documentElement.style.setProperty('--color-b', settings.colorB);
            
            const isRead = myRole === 'read';
            document.querySelectorAll('.action-btn').forEach(b => b.disabled = isRead);
            document.getElementById('reset-btn').style.display = isRead ? 'none' : 'block';
        };

        window.openSettings = () => document.getElementById('settings-screen').style.display = 'block';
        window.saveLocalSettings = () => {
            if(myRole === 'admin') {
                settings.teamA = document.getElementById('set-name-a').value || settings.teamA;
                settings.teamB = document.getElementById('set-name-b').value || settings.teamB;
                settings.colorA = document.getElementById('set-color-a').value;
                settings.colorB = document.getElementById('set-color-b').value;
                pushData();
            }
            document.getElementById('settings-screen').style.display = 'none';
            updateUI();
        };
        window.handleReset = () => { history = [{ga:0, pa:0, gb:0, pb:0}]; currentIndex = 0; pushData(); updateUI(); };
        window.undo = () => { if(currentIndex > 0) { currentIndex--; pushData(); updateUI(); } };

        updateUI();
    </script>
</body>
</html>
