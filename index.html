<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eisstock Profi Deluxe V3</title>
    <style>
        :root { --color-a: #00BFFF; --color-b: #FF4500; --bg: #000; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; overflow: hidden; user-select: none; touch-action: manipulation; }
        .header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #111; border-bottom: 2px solid #333; }
        .btn-top { background: #222; border: 1px solid #444; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .scoreboard { display: flex; gap: 10px; padding: 15px; height: 190px; }
        .team-card { flex: 1; border: 4px solid; border-radius: 25px; background: linear-gradient(145deg, #0f0f0f, #1a1a1a); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .big-score { font-size: 90px; font-weight: 900; line-height: 1; margin: 5px 0; }
        .small-points { font-size: 14px; font-weight: 800; text-transform: uppercase; }
        .controls { display: flex; gap: 15px; padding: 0 15px 10px; }
        .btn-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .btn-stock { padding: 22px; border: none; border-radius: 15px; color: white; font-weight: 900; font-size: 18px; cursor: pointer; box-shadow: 0 5px 0 rgba(0,0,0,0.5); }
        .btn-stock:active { transform: translateY(4px); box-shadow: none; }
        .nav-footer { display: flex; justify-content: center; gap: 15px; padding: 15px; }
        .btn-nav { background: #eee; color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: 900; flex: 1; font-size: 14px; cursor: pointer; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; overflow-y: auto; }
        .tab-bar { display: flex; background: #111; border-bottom: 2px solid #333; position: sticky; top: 0; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #555; font-weight: bold; cursor: pointer; }
        .tab.active { color: var(--color-a); border-bottom: 4px solid var(--color-a); }
        .s-body { padding: 20px; padding-bottom: 80px; display: flex; flex-direction: column; gap: 12px; }
        .s-row { margin-bottom: 5px; }
        .s-label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .s-input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-save { background: #28a745; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-back-main { background: #444; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-danger { background: #d9534f; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 30px; }
        .win-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #0a0a0a; border: 5px solid red; border-radius: 30px; padding: 30px; text-align: center; z-index: 2000; }
        .win-overlay-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1999; }
        .member-list { background: #111; border-radius: 10px; padding: 10px; margin-top: 10px; border: 1px solid #222; }
        .member-item { padding: 8px; border-bottom: 1px solid #222; font-size: 14px; color: #00ff00; }
        .member-item:last-child { border: none; }
        .check-row { display: flex; align-items: center; gap: 10px; background: #111; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="header">
        <button class="btn-top" onclick="resetGame()">NEU SPIEL</button>
        <div style="text-align:center">
            <h1 style="font-size:15px; margin:0;">EISSTOCK PROFI</h1>
            <div id="room-info" style="font-size:10px; color:var(--color-a); font-weight:bold;">LOKAL</div>
        </div>
        <button class="btn-top" onclick="openSettings()">‚öôÔ∏è OPTIONEN</button>
    </div>

    <div class="scoreboard">
        <div class="team-card" id="card-a"><div id="disp-na" class="small-points">TEAM A</div><div id="val-ga" class="big-score">0</div><div id="val-pa" class="small-points">PUNKTE: 0</div></div>
        <div class="team-card" id="card-b"><div id="disp-nb" class="small-points">TEAM B</div><div id="val-gb" class="big-score">0</div><div id="val-pb" class="small-points">PUNKTE: 0</div></div>
    </div>

    <div class="controls">
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 2)">2 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 3)">3 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-a)" onclick="addStock('A', 4)">4 ST√ñCKE</button>
        </div>
        <div class="btn-col">
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 1)">1 STOCK</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 2)">2 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 3)">3 ST√ñCKE</button>
            <button class="btn-stock" style="background:var(--color-b)" onclick="addStock('B', 4)">4 ST√ñCKE</button>
        </div>
    </div>

    <div class="nav-footer">
        <button class="btn-nav" id="undo" onclick="historyStep(-1)">‚Üê KORREKTUR</button>
        <button class="btn-nav" id="redo" onclick="historyStep(1)">VORW√ÑRTS ‚Üí</button>
    </div>

    <div id="win-overlay-bg" class="win-overlay-bg"></div>
    <div id="win-modal" class="win-modal">
        <h2 id="win-label" style="color:red; margin:0; font-size:28px;">SIEG!</h2>
        <div id="win-score-display" style="font-size:60px; font-weight:900; margin:15px 0; color:white;">0 : 0</div>
        <p id="win-payment-text" style="font-size:20px; color:#00ff00; font-weight:bold; margin-bottom:25px;"></p>
        <button class="btn-save" onclick="resetGame()">NEUES SPIEL</button>
    </div>

    <div id="settings" class="overlay">
        <div class="tab-bar">
            <div id="t1" class="tab active" onclick="setTab(1)">ALLGEMEIN</div>
            <div id="t2" class="tab" onclick="setTab(2)">ONLINE</div>
        </div>
        
        <div id="s1" class="s-body">
            <div class="s-row"><label class="s-label">Team A / Farbe</label><div style="display:flex; gap:10px;"><input id="set-na" class="s-input"><input type="color" id="set-ca" style="width:60px; height:45px;"></div></div>
            <div class="s-row"><label class="s-label">Team B / Farbe</label><div style="display:flex; gap:10px;"><input id="set-nb" class="s-input"><input type="color" id="set-cb" style="width:60px; height:45px;"></div></div>
            <div style="display:flex; gap:10px;"><div style="flex:1"><label class="s-label">1. Stock</label><input type="number" id="set-p1" class="s-input"></div><div style="flex:1"><label class="s-label">Folge</label><input type="number" id="set-pn" class="s-input"></div></div>
            <div style="display:flex; gap:10px;"><div style="flex:1"><label class="s-label">Ziel</label><input type="number" id="set-pw" class="s-input"></div><div style="flex:1"><label class="s-label">Sieg ‚Ç¨</label><input type="number" id="set-pe" class="s-input" step="0.1"></div></div>
            <div class="s-row"><label class="s-label">3:0 Preis ‚Ç¨</label><input type="number" id="set-pe3" class="s-input" step="0.1"></div>
            
            <div class="check-row">
                <input type="checkbox" id="set-reset0" style="width:20px; height:20px;">
                <label style="font-size:14px; font-weight:bold;">Gegner bei Sieg auf 0 setzen</label>
            </div>

            <button class="btn-save" onclick="saveSettings()">Speichern & Zur√ºck</button>
            <button class="btn-back-main" onclick="closeSettings()">Nur Zur√ºck</button>
            <button class="btn-danger" onclick="resetToDefaults()">Auf Werkseinstellungen zur√ºcksetzen</button>
        </div>
        
        <div id="s2" class="s-body" style="display:none">
            <div id="online-setup">
                <input id="user-name" class="s-input" placeholder="Dein Name...">
                <button class="btn-save" style="margin-top:10px; background:var(--color-a);" onclick="hostGame()">RAUM ERSTELLEN</button>
                <div style="display:flex; gap:5px; margin-top:10px;"><input id="join-code" class="s-input" placeholder="CODE"><button class="btn-top" onclick="joinGame()">JOIN</button></div>
            </div>
            <div id="online-active" style="display:none;">
                <h1 id="room-code-display" style="font-size:50px; color:#00ff00; text-align:center; margin:0;">-----</h1>
                <button onclick="shareWhatsApp()" style="width:100%; background:#25D366; color:white; border:none; padding:15px; border-radius:30px; font-weight:bold; margin:15px 0;">WhatsApp Einladung</button>
                <div class="s-label">SPIELER IM RAUM:</div>
                <div id="member-list" class="member-list"></div>
                
                <button class="btn-save" style="margin-top:20px; background:var(--color-a);" onclick="closeSettings()">ZUM SPIEL</button>
                <button class="btn-danger" onclick="leaveRoom()" style="width:100%">RAUM VERLASSEN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB6J-4EwyyxuvL8L4kJsfLYBwhnd0xOX2U", authDomain: "eisstock-live.firebaseapp.com", projectId: "eisstock-live", databaseURL: "https://eisstock-live-default-rtdb.europe-west1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const DEFAULTS = { na:"Team A", nb:"Team B", ca:"#00BFFF", cb:"#FF4500", p1:6, pn:3, pw:12, pe:0.50, pe3:1.50, r0: true };
        let config = JSON.parse(localStorage.getItem('es_v3_cfg')) || {...DEFAULTS};
        let state = { ga:0, pa:0, gb:0, pb:0, win: false, history: [], hIdx: -1 };
        let room = localStorage.getItem('es_room');
        let myId = localStorage.getItem('es_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('es_uid', myId);

        function updateHistory(n) {
            let h = n.history || [];
            let idx = n.hIdx ?? -1;
            const currentState = { ga: n.ga, pa: n.pa, gb: n.gb, pb: n.pb, win: n.win };
            h = h.slice(0, idx + 1);
            h.push(currentState);
            if(h.length > 20) h.shift();
            n.history = h;
            n.hIdx = h.length - 1;
            return n;
        }

        window.addStock = (team, count) => {
            if(state.win) return;
            let n = JSON.parse(JSON.stringify(state));
            let val = (team === 'A') ? n.pa : n.pb;
            let p = (val === 0) ? parseInt(config.p1) + (count-1)*parseInt(config.pn) : count*parseInt(config.pn);
            
            if(team === 'A') {
                n.pa += p;
                if(n.pa >= config.pw) { 
                    n.ga++; n.pa = 0; 
                    if(config.r0) n.pb = 0; 
                }
            } else {
                n.pb += p;
                if(n.pb >= config.pw) { 
                    n.gb++; n.pb = 0; 
                    if(config.r0) n.pa = 0; 
                }
            }
            if((n.ga + n.gb) === 3) n.win = true;
            broadcast(updateHistory(n));
        };

        window.historyStep = (dir) => {
            let n = JSON.parse(JSON.stringify(state));
            let newIdx = (n.hIdx || 0) + dir;
            if(n.history && n.history[newIdx]) {
                const past = n.history[newIdx];
                n.ga = past.ga; n.pa = past.pa; n.gb = past.gb; n.pb = past.pb; n.win = past.win;
                n.hIdx = newIdx;
                broadcast(n);
            }
        };

        function broadcast(n) {
            n.ts = Date.now();
            if(room) {
                update(ref(db, 'rooms/' + room), { state: n });
            } else {
                state = n;
                render();
            }
        }

        window.render = () => {
            document.getElementById('val-ga').innerText = state.ga;
            document.getElementById('val-gb').innerText = state.gb;
            document.getElementById('val-pa').innerText = "PUNKTE: " + state.pa;
            document.getElementById('val-pb').innerText = "PUNKTE: " + state.pb;
            document.getElementById('disp-na').innerText = config.na;
            document.getElementById('disp-nb').innerText = config.nb;
            document.getElementById('card-a').style.borderColor = config.ca;
            document.getElementById('card-b').style.borderColor = config.cb;
            document.documentElement.style.setProperty('--color-a', config.ca);
            document.documentElement.style.setProperty('--color-b', config.cb);

            if(state.win) {
                const isTriple = (state.ga === 3 || state.gb === 3) && (state.ga === 0 || state.gb === 0);
                const winner = state.ga > state.gb ? config.na : config.nb;
                document.getElementById('win-label').innerText = winner + " GEWINNT!";
                document.getElementById('win-score-display').innerText = state.ga + " : " + state.gb;
                document.getElementById('win-payment-text').innerText = "Verlierer zahlt " + (isTriple ? config.pe3 : config.pe).toFixed(2) + " ‚Ç¨";
                document.getElementById('win-modal').style.display = 'block';
                document.getElementById('win-overlay-bg').style.display = 'block';
            } else {
                document.getElementById('win-modal').style.display = 'none';
                document.getElementById('win-overlay-bg').style.display = 'none';
            }
        };

        window.resetGame = () => {
            let n = { ga:0, pa:0, gb:0, pb:0, win: false, history: [], hIdx: -1 };
            broadcast(updateHistory(n));
        };

        window.resetToDefaults = () => {
            if(confirm("Alle lokalen Daten l√∂schen und Werkseinstellungen laden?")) {
                localStorage.clear();
                window.location.href = window.location.pathname; 
            }
        };

        window.openSettings = () => {
            document.getElementById('set-na').value = config.na;
            document.getElementById('set-nb').value = config.nb;
            document.getElementById('set-ca').value = config.ca;
            document.getElementById('set-cb').value = config.cb;
            document.getElementById('set-p1').value = config.p1;
            document.getElementById('set-pn').value = config.pn;
            document.getElementById('set-pw').value = config.pw;
            document.getElementById('set-pe').value = config.pe;
            document.getElementById('set-pe3').value = config.pe3;
            document.getElementById('set-reset0').checked = config.r0;
            document.getElementById('settings').style.display = 'block';
        };

        window.saveSettings = () => {
            config.na = document.getElementById('set-na').value;
            config.nb = document.getElementById('set-nb').value;
            config.ca = document.getElementById('set-ca').value;
            config.cb = document.getElementById('set-cb').value;
            config.p1 = parseInt(document.getElementById('set-p1').value);
            config.pn = parseInt(document.getElementById('set-pn').value);
            config.pw = parseInt(document.getElementById('set-pw').value);
            config.pe = parseFloat(document.getElementById('set-pe').value);
            config.pe3 = parseFloat(document.getElementById('set-pe3').value);
            config.r0 = document.getElementById('set-reset0').checked;
            localStorage.setItem('es_v3_cfg', JSON.stringify(config));
            if(room) update(ref(db, 'rooms/' + room), { settings: config });
            render();
            closeSettings();
        };

        window.closeSettings = () => { document.getElementById('settings').style.display = 'none'; };

        window.hostGame = () => {
            const name = document.getElementById('user-name').value;
            if(!name) return alert("Bitte Name eingeben");
            const newRoom = Math.random().toString(36).substr(2, 5).toUpperCase();
            let initialState = updateHistory({ ga:0, pa:0, gb:0, pb:0, win: false, history: [], hIdx: -1 });
            set(ref(db, 'rooms/' + newRoom), { state: initialState, settings: config, members: {[myId]: {name}}, date: new Date().toLocaleDateString() });
            room = newRoom;
            localStorage.setItem('es_room', room);
            localStorage.setItem('es_name', name);
            initSession();
        };

        window.joinGame = (forced) => {
            const c = forced || document.getElementById('join-code').value.toUpperCase();
            let name = localStorage.getItem('es_name') || document.getElementById('user-name').value;
            if(!name) {
                name = prompt("Dein Name f√ºr den Raum:");
                if(!name) return;
                localStorage.setItem('es_name', name);
            }
            update(ref(db, `rooms/${c}/members/${myId}`), { name }).then(() => {
                room = c;
                localStorage.setItem('es_room', room);
                initSession();
            });
        };

        function initSession() {
            if(!room) return;
            document.getElementById('online-setup').style.display = 'none';
            document.getElementById('online-active').style.display = 'block';
            document.getElementById('room-code-display').innerText = room;
            document.getElementById('room-info').innerText = "ONLINE: " + room;
            onValue(ref(db, 'rooms/' + room), (snap) => {
                const data = snap.val();
                if(!data) return;
                state = data.state;
                config = data.settings;
                
                // Spielerliste rendern
                const list = document.getElementById('member-list');
                list.innerHTML = "";
                if(data.members) {
                    Object.values(data.members).forEach(m => {
                        let div = document.createElement('div');
                        div.className = "member-item";
                        div.innerText = "üë§ " + m.name;
                        list.appendChild(div);
                    });
                }
                render();
            });
        }

        window.leaveRoom = () => {
            remove(ref(db, `rooms/${room}/members/${myId}`));
            localStorage.removeItem('es_room');
            location.reload();
        };

        window.shareWhatsApp = () => {
            const link = window.location.href.split('?')[0] + "?join=" + room;
            window.open(`https://wa.me/?text=${encodeURIComponent("Komm in meinen Eisstock-Raum! " + link)}`);
        };

        window.setTab = (n) => {
            document.getElementById('s1').style.display = n === 1 ? 'block' : 'none';
            document.getElementById('s2').style.display = n === 2 ? 'block' : 'none';
            document.getElementById('t1').className = n === 1 ? 'tab active' : 'tab';
            document.getElementById('t2').className = n === 2 ? 'tab active' : 'tab';
        };

        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('join')) joinGame(urlParams.get('join'));
        else if(room) initSession();
        if(state.hIdx === -1) state = updateHistory(state);
        render();
    </script>
</body>
</html>
